<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="数据库,MySQL," />





  <link rel="alternate" href="/atom.xml" title="尤尔小屋" type="application/atom+xml" />






<meta name="description" content="SQL内置函数使用大全 本文中总结了SQL中常用的内置函数，包含通用聚合函数、安全检测函数、数学统计函数、字符串函数等">
<meta name="keywords" content="数据库,MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="SQL内置函数手册">
<meta property="og:url" content="http:&#x2F;&#x2F;www.renpeter.cn&#x2F;2020&#x2F;04&#x2F;24&#x2F;SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html">
<meta property="og:site_name" content="尤尔小屋">
<meta property="og:description" content="SQL内置函数使用大全 本文中总结了SQL中常用的内置函数，包含通用聚合函数、安全检测函数、数学统计函数、字符串函数等">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;large&#x2F;007S8ZIlgy1ge530xhkr7j30u00zkhdx.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;large&#x2F;007S8ZIlgy1ge5449c779j30hl0d375d.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;large&#x2F;007S8ZIlgy1ge544mrxuuj30hl0d6ta3.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;large&#x2F;007S8ZIlgy1ge5450o0v7j30hj0d4abg.jpg">
<meta property="og:image" content="https:&#x2F;&#x2F;upload-images.jianshu.io&#x2F;upload_images&#x2F;5142014-1e5e233af576382c.jpg?imageMogr2&#x2F;auto-orient&#x2F;strip%7CimageView2&#x2F;2&#x2F;w&#x2F;1200&#x2F;format&#x2F;webp">
<meta property="og:updated_time" content="2020-06-16T01:22:09.309Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;large&#x2F;007S8ZIlgy1ge530xhkr7j30u00zkhdx.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    
    emojis: {
      className: 'github-emoji'
    }
  };
</script>



  <link rel="canonical" href="http://www.renpeter.cn/2020/04/24/SQL内置函数手册.html"/>





  <title>SQL内置函数手册 | 尤尔小屋</title>
  








</head>


<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

   <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <a href="https://github.com/pidada" target="_blank" rel="noopener"><img style="position: absolute; top: 0; right: 0; border: 0" width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_white_ffffff.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">尤尔小屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Stay Foolish Stay Hungry</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            About
          </a>
        </li>
      
        
        <li class="menu-item menu-item-links">
          <a href="/links/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-link"></i> <br />
            
            links
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.renpeter.cn/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="PiQianChao">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/cunshang.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="尤尔小屋">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">SQL内置函数手册</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2020-04-24T19:49:35+08:00">
                2020-4-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/%E8%BF%9B%E9%98%B6/" itemprop="url" rel="index">
                    <span itemprop="name">进阶</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2020/04/24/SQL内置函数手册.html" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Words count in article&#58;</span>
                
                <span title="Words count in article">
                  9.6k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Reading time &asymp;</span>
                
                <span title="Reading time">
                  41
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h3 id="SQL内置函数使用大全">SQL内置函数使用大全</h3>
<p>本文中总结了SQL中常用的内置函数，包含<strong>通用聚合函数、安全检测函数、数学统计函数、字符串函数</strong>等</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge530xhkr7j30u00zkhdx.jpg" alt=""></p>
<a id="more"></a>
<h3 id="通用聚合函数">通用聚合函数</h3>
<table>
<thead>
<tr>
<th style="text-align:left">语句</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>arbitrary(x)</code></td>
<td style="text-align:left">随机返回x列中的一个值。</td>
<td style="text-align:left"><code>latency &gt; 100 | select arbitrary(method)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>avg(x)</code></td>
<td style="text-align:left">计算x列的算数平均值。</td>
<td style="text-align:left"><code>latency &gt; 100 | select avg(latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>checksum(x)</code></td>
<td style="text-align:left">计算某一列的checksum，返回base64编码。</td>
<td style="text-align:left"><code>latency &gt; 100 | select checksum(method)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>count(*)</code></td>
<td style="text-align:left">表示所有的行数。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><code>count(x)</code></td>
<td style="text-align:left">计算某一列非null的个数。</td>
<td style="text-align:left"><code>latency &gt; 100 | select count(method) </code></td>
</tr>
<tr>
<td style="text-align:left"><code>count(数字)</code></td>
<td style="text-align:left"><code>count(数字)</code>，如<code>count(1)</code>，等同于<code>count(*)</code>，表示所有的行数。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><code>count_if(x)</code></td>
<td style="text-align:left">计算x=true的个数。</td>
<td style="text-align:left"><code>latency &gt; 100 | select count_if(url like ‘%abc’) </code></td>
</tr>
<tr>
<td style="text-align:left"><code>geometric_mean(x)</code></td>
<td style="text-align:left">计算某一列的几何平均数。</td>
<td style="text-align:left"><code>latency &gt; 100 | select geometric_mean(latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>max_by(x,y)</code></td>
<td style="text-align:left">返回当y取最大值时，x当前的值。</td>
<td style="text-align:left">查询延时最高的时候，对应的method：<code>latency&gt;100 | select max_by(method,latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>max_by(x,y,n)</code></td>
<td style="text-align:left">返回y最高的n行，对应的x的值。</td>
<td style="text-align:left">查询延时最高的3行，对应的method：<code>latency &gt; 100 | select max_by(method,latency,3)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>min_by(x,y)</code></td>
<td style="text-align:left">返回当y取最小值时，x当前的值。</td>
<td style="text-align:left">查询延时最低的请求，对应的method：<code>* | select min_by(x,y)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>min_by(x,y,n)</code></td>
<td style="text-align:left">返回y最小的n行，对应的x的值。</td>
<td style="text-align:left">查询延时最小的3行，对应的method： <code>* | select min_by(method,latency,3)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>max(x)</code></td>
<td style="text-align:left">返回最大值。</td>
<td style="text-align:left"><code>latency &gt; 100| select max(inflow)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>min(x)</code></td>
<td style="text-align:left">返回最小值。</td>
<td style="text-align:left"><code>latency &gt; 100| select min(inflow)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>sum(x)</code></td>
<td style="text-align:left">返回x列的和。</td>
<td style="text-align:left"><code>latency &gt; 10 | select sum(inflow)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>bitwise_and_agg(x)</code></td>
<td style="text-align:left">对某一列的所有数值做and计算。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><code>bitwise_or_agg(x)</code></td>
<td style="text-align:left">对某一列的数值做or计算。</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<h3 id="安全检测函数">安全检测函数</h3>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">security_check_ip</td>
<td style="text-align:left">检查IP是否安全，其中：返回1：命中，表示不安全返回0：未命中</td>
<td style="text-align:left"><code>select security_check_ip(real_client_ip)</code></td>
</tr>
<tr>
<td style="text-align:left">security_check_domain</td>
<td style="text-align:left">检查Domain是否安全，其中：返回1：命中，表示不安全返回0：未命中</td>
<td style="text-align:left"><code>select security_check_domain(site)</code></td>
</tr>
<tr>
<td style="text-align:left">security_check_url</td>
<td style="text-align:left">检查URL是否安全，其中：返回1：命中，表示不安全返回0：未命中</td>
<td style="text-align:left"><code>select security_check_domain(concat(host, url))</code></td>
</tr>
</tbody>
</table>
<h3 id="Map映射函数">Map映射函数</h3>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">下标运算符[]</td>
<td style="text-align:left">获取map中某个Key对应的结果。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">histogram(x)</td>
<td style="text-align:left">按照x的每个值进行GROUP BY并计算count。语法相当于<code>select count group by x </code>。<strong>说明</strong> 返回结果为JSON格式。</td>
<td style="text-align:left"><code> latency &gt; 10 | select histogram(status)</code>，等同于<code>latency &gt; 10 | select count(1) group by status</code>。</td>
</tr>
<tr>
<td style="text-align:left">histogram_u(x)</td>
<td style="text-align:left">按照x的每个值进行GROUP BY并计算count。<strong>说明</strong> 返回结果为多行多列。</td>
<td style="text-align:left"><code>latency &gt; 10 | select histogram(status)</code>，等同于<code>latency &gt; 10 | select count(1) group by status</code>。</td>
</tr>
<tr>
<td style="text-align:left">map_agg(Key,Value)</td>
<td style="text-align:left">返回Key、Value组成的map，并返回每个Key随机的Value。</td>
<td style="text-align:left"><code>latency &gt; 100 | select map_agg(method,latency)</code></td>
</tr>
<tr>
<td style="text-align:left">multimap_agg(Key,Value)</td>
<td style="text-align:left">返回Key、Value组成的多Value map，并返回每个Key的所有的Value。</td>
<td style="text-align:left"><code>latency &gt; 100 | select multimap_agg(method,latency)</code></td>
</tr>
<tr>
<td style="text-align:left">cardinality(x) → bigint</td>
<td style="text-align:left">获取map的大小。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">element_at(map``, key) → V</td>
<td style="text-align:left">获取Key对应的Value。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">map() → map``</td>
<td style="text-align:left">返回一个空的map。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">map(array<code>, array</code>) → map``</td>
<td style="text-align:left">将两个数组转换成Key、Value组成的Map。</td>
<td style="text-align:left"><code>SELECT map(ARRAY[1,3], ARRAY[2,4]); — {1 -&gt; 2, 3 -&gt; 4}</code></td>
</tr>
<tr>
<td style="text-align:left">map_from_entries(array<code>&gt;</code>) → map``</td>
<td style="text-align:left">把一个多维数组转化成map。</td>
<td style="text-align:left"><code>SELECT map_from_entries(ARRAY[(1, ‘x’), (2, ‘y’)]); — {1 -&gt; ‘x’, 2 -&gt; ‘y’}</code></td>
</tr>
<tr>
<td style="text-align:left">map_concat(map1<code>, map2</code>, …, mapN<code>) → map</code></td>
<td style="text-align:left">求多个map的并集，如果某个Key存在于多个map中，则取最后一个。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">map_filter(map<code>, function) → map</code></td>
<td style="text-align:left">请参见<a href="https://help.aliyun.com/document_detail/67401.html#reference-zwt-jmq-zdb" target="_blank" rel="noopener">Lambda函数</a>中map_filter函数。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">map_keys(x<code>) → array</code></td>
<td style="text-align:left">获取map中所有的Key并以array的形式返回。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">map_values(x<code>) → array</code></td>
<td style="text-align:left">获取map中所有的Value并以array的形式返回。</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<h3 id="估算函数">估算函数</h3>
<p>桶是按照聚集程度均分的，每个结果里显示这个区域的均值和个数</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">说明</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>approx_distinct(x)</code></td>
<td style="text-align:left">估算x列的唯一值的个数。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><code>approx_percentile(x,percentage)</code></td>
<td style="text-align:left">对于x列排序，找出大约处于percentage位置的数值。</td>
<td style="text-align:left">找出位于一半位置的数值：<code>approx_percentile(x,0.5)</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>approx_percentile(x, percentages)</code></td>
<td style="text-align:left">与<code>approx_percentile(x,percentage)</code>用法类似，但可以指定多个percentage，找出每个percentage对应的数值。</td>
<td style="text-align:left"><code>approx_percentile(x,array[0.1,0.2])</code></td>
</tr>
<tr>
<td style="text-align:left"><code>numeric_histogram(buckets, Value)</code></td>
<td style="text-align:left">对于数值列，分多个桶进行统计。即把Value一列，分到桶中，桶的个数为buckets。返回内容为每个桶的Key及对应的count数值，相当于针对数值的<code>select count group by</code>。<strong>说明</strong> 返回结果的格式为JSON。</td>
<td style="text-align:left">对于POST请求，把延时分为10个桶，查看每个桶的大小：<code>method:POST | select numeric_histogram(10,latency)</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>numeric_histogram_u(buckets, Value)</code></td>
<td style="text-align:left">对于数值列，分多个桶进行统计。即把Value一列，分到桶中，桶的个数为buckets。返回内容为每个桶的Key及对应的count数值，相当于针对数值的<code>select count group by</code>。<strong>说明</strong> 返回结果的格式为多行多列。</td>
<td style="text-align:left">对于POST请求，把延时分为10个桶，查看每个桶的大小：<code>method:POST | select numeric_histogram_u(10,latency)</code>。</td>
</tr>
</tbody>
</table>
<h3 id="数学统计函数">数学统计函数</h3>
<table>
<thead>
<tr>
<th style="text-align:left">语句</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>corr(y, x)</code></td>
<td style="text-align:left">给出两列的相关度，结果从0到1。</td>
<td style="text-align:left"><code>latency&gt;100| select corr(latency,request_size)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>covar_pop(y, x)</code></td>
<td style="text-align:left">计算总体协方差。</td>
<td style="text-align:left"><code>latency&gt;100| select covar_pop(request_size,latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>covar_samp(y, x)</code></td>
<td style="text-align:left">计算样本协方差。</td>
<td style="text-align:left"><code>latency&gt;100| select covar_samp(request_size,latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regr_intercept(y, x)</code></td>
<td style="text-align:left">返回输入值的线性回归截距。 y是依赖值， x是独立值。</td>
<td style="text-align:left"><code>latency&gt;100| select regr_intercept(request_size,latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regr_slope(y,x)</code></td>
<td style="text-align:left">返回输入值的线性回归斜率。 y是依赖值， x是独立值。</td>
<td style="text-align:left"><code>latency&gt;100| select regr_slope(request_size,latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>stddev(x)</code>或<code>stddev_samp(x)</code></td>
<td style="text-align:left">返回x列的样本标准差。</td>
<td style="text-align:left"><code>latency&gt;100| select stddev(latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>stddev_pop(x)</code></td>
<td style="text-align:left">返回x列的总体标准差。</td>
<td style="text-align:left"><code>latency&gt;100| select stddev_pop(latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>variance(x)</code>或 <code>var_samp(x)</code></td>
<td style="text-align:left">计算x列的样本方差。</td>
<td style="text-align:left"><code>latency&gt;100| select variance(latency)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>var_pop(x)</code></td>
<td style="text-align:left">计算x列的总体方差。</td>
<td style="text-align:left"><code>latency&gt;100| select variance(latency)</code></td>
</tr>
</tbody>
</table>
<h3 id="数学计算函数">数学计算函数</h3>
<p>支持的运算符号：<code>+、-、*、/、%</code>；可以用在<code>select</code>句子中</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>abs(x)</code></td>
<td style="text-align:left">返回x列的绝对值。</td>
</tr>
<tr>
<td style="text-align:left"><code>cbrt(x)</code></td>
<td style="text-align:left">返回x列的立方根。</td>
</tr>
<tr>
<td style="text-align:left"><code>ceiling（x）</code></td>
<td style="text-align:left">返回x列向上最接近的整数。</td>
</tr>
<tr>
<td style="text-align:left"><code>cosine_similarity(x,y)</code></td>
<td style="text-align:left">返回稀疏向量x和y之间的余弦相似度。</td>
</tr>
<tr>
<td style="text-align:left"><code>degrees</code></td>
<td style="text-align:left">把弧度转化为度。</td>
</tr>
<tr>
<td style="text-align:left"><code>e()</code></td>
<td style="text-align:left">返回自然常数。</td>
</tr>
<tr>
<td style="text-align:left"><code>exp(x)</code></td>
<td style="text-align:left">返回自然常数的指数。</td>
</tr>
<tr>
<td style="text-align:left"><code>floor(x)</code></td>
<td style="text-align:left">返回x向下最接近的整数。</td>
</tr>
<tr>
<td style="text-align:left"><code>from_base(string,radix)</code></td>
<td style="text-align:left">以radix进制解释string。</td>
</tr>
<tr>
<td style="text-align:left"><code>ln(x)</code></td>
<td style="text-align:left">返回自然对数。</td>
</tr>
<tr>
<td style="text-align:left"><code>log2(x)</code></td>
<td style="text-align:left">返回以2为底，x的对数。</td>
</tr>
<tr>
<td style="text-align:left"><code>log10(x)</code></td>
<td style="text-align:left">返回以10为底，x的对数。</td>
</tr>
<tr>
<td style="text-align:left"><code>log(x,b)</code></td>
<td style="text-align:left">返回以b为底，x的对数。</td>
</tr>
<tr>
<td style="text-align:left"><code>pi()</code></td>
<td style="text-align:left">返回π。</td>
</tr>
<tr>
<td style="text-align:left"><code>pow(x,b)</code></td>
<td style="text-align:left">返回x的b次幂。</td>
</tr>
<tr>
<td style="text-align:left"><code>radians(x)</code></td>
<td style="text-align:left">把度转化成弧度。</td>
</tr>
<tr>
<td style="text-align:left"><code>rand()</code></td>
<td style="text-align:left">返回随机数。</td>
</tr>
<tr>
<td style="text-align:left"><code>random(0,n)</code></td>
<td style="text-align:left">返回[0，n)随机数。</td>
</tr>
<tr>
<td style="text-align:left"><code>round(x)</code></td>
<td style="text-align:left">x四舍五入。</td>
</tr>
<tr>
<td style="text-align:left"><code>round(x, y)</code></td>
<td style="text-align:left">对x保留y个小数为，例如round(1.012345,2) = 1.01。</td>
</tr>
<tr>
<td style="text-align:left"><code>sqrt(x)</code></td>
<td style="text-align:left">返回x的平方根。</td>
</tr>
<tr>
<td style="text-align:left"><code>to_base(x, radix)</code></td>
<td style="text-align:left">把x以radix进制表示。</td>
</tr>
<tr>
<td style="text-align:left"><code>truncate(x)</code></td>
<td style="text-align:left">丢弃掉x的小数部分。</td>
</tr>
<tr>
<td style="text-align:left"><code>acos(x)</code></td>
<td style="text-align:left">反余弦。</td>
</tr>
<tr>
<td style="text-align:left"><code>asin(x)</code></td>
<td style="text-align:left">反正弦。</td>
</tr>
<tr>
<td style="text-align:left"><code>atan(x)</code></td>
<td style="text-align:left">反正切。</td>
</tr>
<tr>
<td style="text-align:left"><code>atan2(y,x)</code></td>
<td style="text-align:left">y/x的反正切。</td>
</tr>
<tr>
<td style="text-align:left"><code>cos(x)</code></td>
<td style="text-align:left">余弦。</td>
</tr>
<tr>
<td style="text-align:left"><code>sin(x)</code></td>
<td style="text-align:left">正弦。</td>
</tr>
<tr>
<td style="text-align:left"><code>cosh(x)</code></td>
<td style="text-align:left">双曲余弦。</td>
</tr>
<tr>
<td style="text-align:left"><code>tan(x)</code></td>
<td style="text-align:left">正切。</td>
</tr>
<tr>
<td style="text-align:left"><code>tanh(x)</code></td>
<td style="text-align:left">双曲正切。</td>
</tr>
<tr>
<td style="text-align:left"><code>infinity()</code></td>
<td style="text-align:left">返回正无穷的数值。</td>
</tr>
<tr>
<td style="text-align:left"><code>is_infinity(x)</code></td>
<td style="text-align:left">判断值是否是无限值。</td>
</tr>
<tr>
<td style="text-align:left"><code>is_finity(x)</code></td>
<td style="text-align:left">判断是否是有限值。</td>
</tr>
<tr>
<td style="text-align:left"><code>is_nan(x)</code></td>
<td style="text-align:left">判断是否是非数值。</td>
</tr>
</tbody>
</table>
<h3 id="字符串函数">字符串函数</h3>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>chr(x)</code></td>
<td style="text-align:left">把int类型转化成对应的ASCII码，例如<code>chr(65)</code>结果为<code>A</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>codepoint (x)</code></td>
<td style="text-align:left">把一个ASCII码转化成int类型的编码，例如<code>codepoint('A')</code>结果为<code>65</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>length(x)</code></td>
<td style="text-align:left">字段长度。</td>
</tr>
<tr>
<td style="text-align:left"><code>levenshtein_distance(string1, string2)</code></td>
<td style="text-align:left">返回两个字符串的最小编辑距离。</td>
</tr>
<tr>
<td style="text-align:left"><code>lower(string)</code></td>
<td style="text-align:left">转化成小写。</td>
</tr>
<tr>
<td style="text-align:left"><code>lpad(string, size, padstring)</code></td>
<td style="text-align:left">把<strong>string</strong>对齐到<strong>size</strong>大小，如果小于<strong>size</strong>，用<strong>padstring</strong>从左侧补齐到；如果大于<strong>size</strong>则截取到<strong>size</strong>个。</td>
</tr>
<tr>
<td style="text-align:left"><code>rpad(string, size, padstring)</code></td>
<td style="text-align:left">类似<code>lpad</code>，从右侧补齐<strong>string</strong>。</td>
</tr>
<tr>
<td style="text-align:left"><code>ltrim(string)</code></td>
<td style="text-align:left">删掉左侧的空白字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>replace(string, search)</code></td>
<td style="text-align:left">把字符串中<strong>string</strong>中的<strong>search</strong>删掉。</td>
</tr>
<tr>
<td style="text-align:left"><code>replace(string, search,rep)</code></td>
<td style="text-align:left">把字符串中<strong>string</strong>中的<strong>search</strong>替换为<strong>rep</strong>。</td>
</tr>
<tr>
<td style="text-align:left"><code>reverse(string)</code></td>
<td style="text-align:left">翻转string。</td>
</tr>
<tr>
<td style="text-align:left"><code>rtrim(string)</code></td>
<td style="text-align:left">删掉字符串结尾的空白字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>split(string,delimeter,limit)</code></td>
<td style="text-align:left">把字符串分裂成array，最多取<strong>limit</strong>个值。生成的结果为数组，下标从1开始。</td>
</tr>
<tr>
<td style="text-align:left"><code>split_part(string,delimeter,offset)</code></td>
<td style="text-align:left">把字符串分裂成array，取第<strong>offset</strong>个字符串。生成的结果为字符串。</td>
</tr>
<tr>
<td style="text-align:left"><code>split_to_map(string, entryDelimiter, keyValueDelimiter) → map</code></td>
<td style="text-align:left">把<strong>string</strong>按照<strong>entryDelemiter</strong>分割成多个entry，每个entry再按照<strong>keyValueDelimiter</strong>划分成key value。最终返回一个map。</td>
</tr>
<tr>
<td style="text-align:left"><code>position(substring IN string)</code></td>
<td style="text-align:left">获取<strong>string</strong>中，<strong>substring</strong>最先开始的位置。</td>
</tr>
<tr>
<td style="text-align:left"><code>strpos(string, substring)</code></td>
<td style="text-align:left">查找字符串中的子串的开始位置。返回结果从1开始，如果不存在则返回0。</td>
</tr>
<tr>
<td style="text-align:left"><code>substr(string, start)</code></td>
<td style="text-align:left">返回字符串的子串，<strong>start</strong>下标从1开始。</td>
</tr>
<tr>
<td style="text-align:left"><code>substr(string, start, length)</code></td>
<td style="text-align:left">返回字符串的子串，<strong>start</strong>下标从1开始，<strong>length</strong>指定子串的长度。</td>
</tr>
<tr>
<td style="text-align:left"><code>trim(string)</code></td>
<td style="text-align:left">删掉字符串开头和结尾的空白字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>upper(string)</code></td>
<td style="text-align:left">转化为大写字符。</td>
</tr>
<tr>
<td style="text-align:left"><code>concat(string,string......)</code></td>
<td style="text-align:left">把两个或多个字符串拼接成一个字符串。</td>
</tr>
<tr>
<td style="text-align:left"><code>hamming_distance (string1,string2)</code></td>
<td style="text-align:left">获得两个字符串的海明距离。</td>
</tr>
</tbody>
</table>
<h3 id="日期和时间函数">日期和时间函数</h3>
<h4 id="函数类型">函数类型</h4>
<p>日期和时间函数主要是包含：</p>
<ul>
<li>日期函数</li>
<li>时间函数</li>
<li>区间函数</li>
<li>时序补全函数</li>
</ul>
<h4 id="日期时间类型">日期时间类型</h4>
<ol>
<li>时间戳类型unixtime：以int类型表示从1970年1月1日开始的秒数，例如<code>1512374067</code>表示的时间是<code>Mon Dec 4 15:54:27 CST 2017</code>。日志服务每条日志中内置的时间<code>__time__</code>即为这种类型。</li>
<li>timestamp类型：以字符串形式表示，例如：2017-11-01 13:30:00</li>
</ol>
<h4 id="日期函数">日期函数</h4>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>current_date</code></td>
<td style="text-align:left">当天日期。</td>
<td style="text-align:left"><code>latency&gt;100| select current_date</code></td>
</tr>
<tr>
<td style="text-align:left"><code>current_time</code></td>
<td style="text-align:left">当前时间。</td>
<td style="text-align:left"><code>latency&gt;100| select current_time</code></td>
</tr>
<tr>
<td style="text-align:left"><code>current_timestamp</code></td>
<td style="text-align:left">结合current_date 和current_time的结果。</td>
<td style="text-align:left"><code>latency&gt;100| select current_timestamp</code></td>
</tr>
<tr>
<td style="text-align:left"><code>current_timezone()</code></td>
<td style="text-align:left">返回时区。</td>
<td style="text-align:left"><code>latency&gt;100| select current_timezone()</code></td>
</tr>
<tr>
<td style="text-align:left"><code>from_iso8601_timestamp(string)</code></td>
<td style="text-align:left">把iso8601时间转化成带时区的时间。</td>
<td style="text-align:left"><code>latency&gt;100| select from_iso8601_timestamp(iso8601)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>from_iso8601_date(string)</code></td>
<td style="text-align:left">把iso8601转化成天。</td>
<td style="text-align:left"><code>latency&gt;100| select from_iso8601_date(iso8601)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>from_unixtime(unixtime)</code></td>
<td style="text-align:left">把unix时间转化为时间戳。</td>
<td style="text-align:left"><code>latency&gt;100| select from_unixtime(1494985275) </code></td>
</tr>
<tr>
<td style="text-align:left"><code>from_unixtime(unixtime,string)</code></td>
<td style="text-align:left">以string为时区，把unixtime转化成时间戳。</td>
<td style="text-align:left"><code>latency&gt;100| select from_unixtime (1494985275,'Asia/Shanghai')</code></td>
</tr>
<tr>
<td style="text-align:left"><code>localtime</code></td>
<td style="text-align:left">本地时间。</td>
<td style="text-align:left"><code>latency&gt;100| select localtime </code></td>
</tr>
<tr>
<td style="text-align:left"><code>localtimestamp</code></td>
<td style="text-align:left">本地时间戳。</td>
<td style="text-align:left"><code>latency&gt;100| select localtimestamp </code></td>
</tr>
<tr>
<td style="text-align:left"><code>now()</code></td>
<td style="text-align:left">等同于<code>current_timestamp</code>。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><code>to_unixtime(timestamp)</code></td>
<td style="text-align:left">timestamp转化成unixtime。</td>
<td style="text-align:left"><code>*| select to_unixtime('2017-05-17 09:45:00.848 Asia/Shanghai')</code></td>
</tr>
</tbody>
</table>
<h4 id="时间函数">时间函数</h4>
<ul>
<li>date_format(timestamp, format)</li>
<li>date_parse(string, format)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>date_format(timestamp, format)</code></td>
<td style="text-align:left">把timestamp转化成以format形式表示。</td>
<td style="text-align:left"><code>latency&gt;100</code></td>
</tr>
<tr>
<td style="text-align:left"><code>date_parse(string, format)</code></td>
<td style="text-align:left">把string以format格式解析，转化成timestamp。</td>
<td style="text-align:left"><code>latency&gt;100</code></td>
</tr>
</tbody>
</table>
<h4 id="格式说明">格式说明</h4>
<table>
<thead>
<tr>
<th style="text-align:left">格式</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">%a</td>
<td style="text-align:left">星期的缩写，即Sun、Sat等。</td>
</tr>
<tr>
<td style="text-align:left">%b</td>
<td style="text-align:left">月份的缩写，即Jan、Dec等。</td>
</tr>
<tr>
<td style="text-align:left">%c</td>
<td style="text-align:left">月份，数值类型，即1~12。</td>
</tr>
<tr>
<td style="text-align:left">%D</td>
<td style="text-align:left">每月的第几天，带后缀，即0th、1st、2nd、3rd等。</td>
</tr>
<tr>
<td style="text-align:left">%d</td>
<td style="text-align:left">每月第几天，十进制格式，范围为01~31。</td>
</tr>
<tr>
<td style="text-align:left">%e</td>
<td style="text-align:left">每月第几天，十进制格式，范围为1~31。</td>
</tr>
<tr>
<td style="text-align:left">%H</td>
<td style="text-align:left">小时，24小时制。</td>
</tr>
<tr>
<td style="text-align:left">%h</td>
<td style="text-align:left">小时，12小时制。</td>
</tr>
<tr>
<td style="text-align:left">%I</td>
<td style="text-align:left">小时，12小时制。</td>
</tr>
<tr>
<td style="text-align:left">%i</td>
<td style="text-align:left">分钟，数值类型，范围为00~59。</td>
</tr>
<tr>
<td style="text-align:left">%j</td>
<td style="text-align:left">每年的第几天，范围为001~366。</td>
</tr>
<tr>
<td style="text-align:left">%k</td>
<td style="text-align:left">小时，范围为0~23。</td>
</tr>
<tr>
<td style="text-align:left">%l</td>
<td style="text-align:left">小时，范围为1~12。</td>
</tr>
<tr>
<td style="text-align:left">%M</td>
<td style="text-align:left">月份的英文表达，范围为January~December。</td>
</tr>
<tr>
<td style="text-align:left">%m</td>
<td style="text-align:left">月份，数值格式，范围为01~12。</td>
</tr>
<tr>
<td style="text-align:left">%p</td>
<td style="text-align:left">AM或PM。</td>
</tr>
<tr>
<td style="text-align:left">%r</td>
<td style="text-align:left">时间，12小时制，格式为<code>hh:mm:ss AM/PM</code>。</td>
</tr>
<tr>
<td style="text-align:left">%S</td>
<td style="text-align:left">秒，范围为00~59。</td>
</tr>
<tr>
<td style="text-align:left">%s</td>
<td style="text-align:left">秒，范围为00~59。</td>
</tr>
<tr>
<td style="text-align:left">%T</td>
<td style="text-align:left">时间，24时制，格式为 <code>hh:mm:ss</code>。</td>
</tr>
<tr>
<td style="text-align:left">%V</td>
<td style="text-align:left">每年的第几周，星期日是一周的第一天。范围为01~53，与%X同时使用。</td>
</tr>
<tr>
<td style="text-align:left">%v</td>
<td style="text-align:left">每年的第几周，星期一是一周的第一天。范围为01~53，与%x同时使用。</td>
</tr>
<tr>
<td style="text-align:left">%W</td>
<td style="text-align:left">星期几的名称，范围为Sunday到Saturday。</td>
</tr>
<tr>
<td style="text-align:left">%w</td>
<td style="text-align:left">一周的第几天， 星期日为第0天。</td>
</tr>
<tr>
<td style="text-align:left">%Y</td>
<td style="text-align:left">4 位数的年份。</td>
</tr>
<tr>
<td style="text-align:left">%y</td>
<td style="text-align:left">2位数的年份。</td>
</tr>
<tr>
<td style="text-align:left">%%</td>
<td style="text-align:left">%转义字符。</td>
</tr>
</tbody>
</table>
<h4 id="时间段对齐函数">时间段对齐函数</h4>
<p>按照秒、分钟、小时、日、月、年等进行对齐</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">date_trunc(unit,x)</span><br></pre></td></tr></table></figure>
<ul>
<li>x是一个timestamp类型，也可以是unix time</li>
<li>date_trunc只能按照固定时间间隔统计</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*|select  date_trunc(<span class="string">'minute'</span> ,  __time__)  <span class="keyword">as</span> t,</span><br><span class="line">       truncate (avg(latency) ) ,</span><br><span class="line">       current_date</span><br><span class="line">       group by   t</span><br><span class="line">       order by t  desc</span><br><span class="line">       limit <span class="number">60</span></span><br></pre></td></tr></table></figure>
<h4 id="时间间隔函数">时间间隔函数</h4>
<p>时间间隔函数用来执行时间段相关的运算，如在日期中添加或减去指定的时间间隔、计算两个日期之间的时间</p>
<ul>
<li>date_add(unit, value, timestamp)：在timestamp的基础上加上value个unit；如果value是负值，则进行减法</li>
<li>date_diff(unit, timestamp1, timestamp2)：计算两个timestamp之间差几个unit</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>date_add(unit, value, timestamp)</code></td>
<td style="text-align:left">在<code>timestamp</code>上加上<code>value</code>个<code>unit</code>。如果要执行减法，<code>value</code>使用负值。</td>
<td style="text-align:left"><code>date_add('day', -7, '2018-08-09 00:00:00')</code> 表示8月9号之前7天</td>
</tr>
<tr>
<td style="text-align:left"><code>date_diff(unit, timestamp1, timestamp2)</code></td>
<td style="text-align:left">表示<code>timestamp1</code>和<code>timestamp2</code>之间相差几个<code>unit</code>。</td>
<td style="text-align:left"><code>date_diff('day', '2018-08-02 00:00:00', '2018-08-09 00:00:00') = 7</code></td>
</tr>
</tbody>
</table>
<h4 id="函数区间单位">函数区间单位</h4>
<table>
<thead>
<tr>
<th style="text-align:left">单位</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">millisecond</td>
<td style="text-align:left">毫秒</td>
</tr>
<tr>
<td style="text-align:left">second</td>
<td style="text-align:left">秒</td>
</tr>
<tr>
<td style="text-align:left">minute</td>
<td style="text-align:left">分钟</td>
</tr>
<tr>
<td style="text-align:left">hour</td>
<td style="text-align:left">小时</td>
</tr>
<tr>
<td style="text-align:left">day</td>
<td style="text-align:left">天</td>
</tr>
<tr>
<td style="text-align:left">week</td>
<td style="text-align:left">周</td>
</tr>
<tr>
<td style="text-align:left">month</td>
<td style="text-align:left">月</td>
</tr>
<tr>
<td style="text-align:left">quarter</td>
<td style="text-align:left">季度，即三个月</td>
</tr>
<tr>
<td style="text-align:left">year</td>
<td style="text-align:left">年</td>
</tr>
</tbody>
</table>
<h4 id="时序补全函数time-series">时序补全函数time_series</h4>
<p>时序补全函数<code>time_series</code>必须和<code>group by time order by time</code>一起使用，且<code>order by</code>不支持<code>desc</code>排序方式</p>
<p>函数格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time_series(time_column, window, format, padding_data)</span><br></pre></td></tr></table></figure>
<p>参数说明：</p>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">time_column</td>
<td style="text-align:left">时间列，例如日志服务提供的默认时间字段<code>__time__</code>。格式为long类型或timestamp类型。</td>
</tr>
<tr>
<td style="text-align:left">window</td>
<td style="text-align:left">窗口大小，由一个数字和单位组成。单位为s（秒）、m（分）、H （小时）、或d（天）。例如2h、5m、3d。</td>
</tr>
<tr>
<td style="text-align:left">format</td>
<td style="text-align:left">MySQL时间格式，表示最终输出的格式。</td>
</tr>
<tr>
<td style="text-align:left">padding_data</td>
<td style="text-align:left">表示补全的内容，包括：0：补零。null：补null。last：补上一个值。next：补下一个值。avg：补前后的平均值。</td>
</tr>
</tbody>
</table>
<h3 id="URL函数">URL函数</h3>
<p>URL函数支持从标准URL路径中提取字段，一个标准的URL如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[protocol:][//host[:port]][path][?query][<span class="comment">#fragment]</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:center">示例</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">输入样例</td>
<td style="text-align:left">输出结果</td>
<td style="text-align:center"></td>
<td></td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_fragment(url)</code></td>
<td style="text-align:left">提取出URL中的fragment，结果为varchar类型。</td>
<td style="text-align:center"><code>*| select url_extract_fragment('https://sls.console.aliyun.com/#/project/dashboard-demo/categoryList')</code></td>
<td>输出结果为<code>/project/dashboard-demo/categoryList</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_host(url)</code></td>
<td style="text-align:left">提取出URL中的host，结果为varchar类型。</td>
<td style="text-align:center"><code>*|select url_extract_host('http://www.aliyun.com/product/sls')</code>。</td>
<td>输出结果为<code>www.aliyun.com</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_parameter(url, name)</code></td>
<td style="text-align:left">提取出URL中的query中name对应的参数值，结果为varchar类型。</td>
<td style="text-align:center"><code>*|select url_extract_parameter('http://www.aliyun.com/product/sls?userid=testuser','userid')</code></td>
<td>输出结果为<code>testuser</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_path(url)</code></td>
<td style="text-align:left">提取出URL中的path，结果为varchar类型。</td>
<td style="text-align:center"><code>*|select url_extract_path('http://www.aliyun.com/product/sls?userid=testuser')</code></td>
<td>输出结果为<code>/product/sls</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_port(url)</code></td>
<td style="text-align:left">提取出URL中的端口，结果为bigint类型。</td>
<td style="text-align:center"><code>*|select url_extract_port('http://www.aliyun.com:80/product/sls?userid=testuser')</code></td>
<td>输出结果为<code>80</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_protocol(url)</code></td>
<td style="text-align:left">提取出URL中的协议，结果为varchar类型。</td>
<td style="text-align:center"><code>*|select url_extract_protocol('http://www.aliyun.com:80/product/sls?userid=testuser')</code></td>
<td>输出结果为<code>http</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_extract_query(url)</code></td>
<td style="text-align:left">提取出URL中的query，结果为varchar类型。</td>
<td style="text-align:center"><code>*|select url_extract_query('http://www.aliyun.com:80/product/sls?userid=testuser')</code></td>
<td>输出结果为<code>userid=testuser</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_encode(value)</code></td>
<td style="text-align:left">对url进行转义编码。</td>
<td style="text-align:center"><code>*|select url_encode('http://www.aliyun.com:80/product/sls?userid=testuser')</code></td>
<td>输出结果为<code>http%3a%2f%2fwww.aliyun.com%3a80%2fproduct%2fsls%3fuserid%3dtestuser</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>url_decode(value)</code></td>
<td style="text-align:left">对url进行解码。</td>
<td style="text-align:center"><code>*|select url_decode('http%3a%2f%2fwww.aliyun.com%3a80%2fproduct%2fsls%3fuserid%3dtestuser')</code></td>
<td>输出结果为<code>http://www.aliyun.com:80/product/sls?userid=testuser</code>。</td>
</tr>
</tbody>
</table>
<h3 id="正则式函数">正则式函数</h3>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>regexp_extract_all(string, pattern)</code></td>
<td style="text-align:left">返回字符串中命中正则式的<strong>所有子串</strong>，返回结果是一个字符串数组。</td>
<td style="text-align:left"><code>*| SELECT regexp_extract_all('5a 67b 890m', '\d+')</code>，结果为<code>['5','67','890']</code>，<code>*|SELECT regexp_extract_all('5a 67a 890m', '(\d+)a') </code>结果为<code>['5a','67a']</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_extract_all(string, pattern, group)</code></td>
<td style="text-align:left">返回字符串中命中正则式的<strong>第group个<code>()</code>内部分</strong>，返回结果是一个字符串数组。</td>
<td style="text-align:left"><code>*| SELECT regexp_extract_all(‘5a 67a 890m’, ‘(\d+)a’,1) </code>结果为<code>[‘5’,’67’]</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_extract(string, pattern)</code></td>
<td style="text-align:left">返回字符串命中的正则式的<strong>第一个子串</strong>。</td>
<td style="text-align:left"><code>*|SELECT regexp_extract('5a 67b 890m', '\d+') </code>结果为<code>'5'</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_extract(string, pattern,group)</code></td>
<td style="text-align:left">返回字符串命中的正则式的<strong>第group个<code>()</code>内的第1个子串</strong>。</td>
<td style="text-align:left"><code>*|SELECT regexp_extract('5a 67b 890m', '(\d+)([a-z]+)',2) </code>结果为<code>'a'</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_like(string, pattern)</code></td>
<td style="text-align:left">判断字符串是否命中正则式，返回bool类型，正则式可以只命中字符串的一部分。</td>
<td style="text-align:left"><code>*|SELECT regexp_like('5a 67b 890m', '\d+m') </code>结果为true</td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_replace(string, pattern, replacement)</code></td>
<td style="text-align:left">把字符串中命中正则式的部分替换成replacement。</td>
<td style="text-align:left"><code>*|SELECT regexp_replace('5a 67b 890m', '\d+','a') </code>结果为<code>'aa ab am'</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_replace(string, pattern)</code></td>
<td style="text-align:left"><strong>把字符串中命中正则式的部分删除</strong>，相当于<code>regexp_replace(string,patterm,'')</code>。</td>
<td style="text-align:left"><code>*|SELECT regexp_replace('5a 67b 890m', '\d+') </code>结果为<code>'a b m'</code></td>
</tr>
<tr>
<td style="text-align:left"><code>regexp_split(string, pattern)</code></td>
<td style="text-align:left">使用正则式把字符串切分成数组。</td>
<td style="text-align:left"><code>*|SELECT regexp_split('5a 67b 890m', '\d+') </code>结果为<code>['a','b','m']</code></td>
</tr>
</tbody>
</table>
<h3 id="JSON函数">JSON函数</h3>
<p>JSON主要有两种结构：<strong>map和array</strong>。如果一个字符串解析成JSON失败，那么返回的是null。</p>
<ul>
<li>json_parse(string)：将字符串转成JSON类型</li>
<li>json_format(json)：将json类型转成字符串</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>json_parse(string)</code></td>
<td style="text-align:left">把字符串转化成JSON类型。</td>
<td style="text-align:left"><code>SELECT json_parse('[1, 2, 3]')</code> 结果为JSON类型数组</td>
</tr>
<tr>
<td style="text-align:left"><code>json_format(json)</code></td>
<td style="text-align:left">把JSON类型转化成字符串。</td>
<td style="text-align:left"><code>SELECT json_format(json_parse('[1, 2, 3]')) </code>结果为字符串</td>
</tr>
<tr>
<td style="text-align:left"><code>json_array_contains(json, value)</code></td>
<td style="text-align:left">判断一个JSON类型数值，或者一个字符串（内容是一个JSON数组）是否包含某个值。</td>
<td style="text-align:left"><code>SELECT json_array_contains(json_parse('[1, 2, 3]'), 2)或 SELECT json_array_contains('[1, 2, 3]', 2)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>json_array_get(json_array, index)</code></td>
<td style="text-align:left">同<code>json_array_contains</code>，是获取一个JSON数组的某个下标对应的元素。</td>
<td style="text-align:left"><code>SELECT json_array_get('[&quot;a&quot;, &quot;b&quot;, &quot;c&quot;]', 0)结果为'a'</code></td>
</tr>
<tr>
<td style="text-align:left"><code>json_array_length(json)</code></td>
<td style="text-align:left">返回JSON数组的大小。</td>
<td style="text-align:left"><code>SELECT json_array_length('[1, 2, 3]') 返回结果3</code></td>
</tr>
<tr>
<td style="text-align:left"><code>json_extract(json, json_path)</code></td>
<td style="text-align:left">从一个JSON对象中提取值，JSON路径的语法类似<code>$.store.book[0].title</code>，返回结果是一个JSON对象。</td>
<td style="text-align:left"><code>SELECT json_extract(json, '$.store.book');</code></td>
</tr>
<tr>
<td style="text-align:left"><code>json_extract_scalar(json, json_path)</code></td>
<td style="text-align:left">类似<code>json_extract</code>，但是返回结果是字符串类型。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left"><code>json_size(json,json_path)</code></td>
<td style="text-align:left">获取JSON对象或数组的大小。</td>
<td style="text-align:left"><code>SELECT json_size('[1, 2, 3]') 返回结果3</code></td>
</tr>
</tbody>
</table>
<h3 id="类型转换函数">类型转换函数</h3>
<p>类型转换函数用于在查询中转换指定值或指定列的数据类型。</p>
<h4 id="函数格式">函数格式</h4>
<ul>
<li>在查询中将某一列（字段）或某一个值转换成指定类型。其中，<strong>如果某一个值转换失败，将终止整个查询</strong>。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cast([key|value] <span class="keyword">as</span> type)</span><br></pre></td></tr></table></figure>
<ul>
<li>在查询中将某一列（字段）或某一个值转换成指定类型。<strong>如果某一个值转换失败，该值返回NULL，并跳过该值继续处理</strong>。</li>
</ul>
<h4 id="参数">参数</h4>
<table>
<thead>
<tr>
<th style="text-align:left">参数</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">key</td>
<td style="text-align:left">日志的Key，表示将该字段所有的值都转换成指定类型</td>
</tr>
<tr>
<td style="text-align:left">value</td>
<td style="text-align:left">常量值，表示将某个值转换成指定类型</td>
</tr>
</tbody>
</table>
<h4 id="示例">示例</h4>
<ul>
<li>
<p>将数字123转换为字符串（varchar）格式：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cast(<span class="number">123</span> <span class="keyword">AS</span> <span class="type">varchar</span>)</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>将uid字段转换为字符串（varchar）格式：</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cast(uid <span class="keyword">AS</span> <span class="type">varchar</span>)</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="IP地理函数">IP地理函数</h3>
<p>IP 地理函数可以识别一个 IP 是内网 IP还是外网 IP，也可以判断 IP 所属的国家、省份、城市</p>
<h4 id="常用函数">常用函数</h4>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>ip_to_domain(ip)</code></td>
<td style="text-align:left">判断 IP 所在的域，是内网还是外网。返回 intranet 或 internet。</td>
<td style="text-align:left"><code>SELECT ip_to_domain(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_country(ip)</code></td>
<td style="text-align:left">判断 IP 所在的国家。</td>
<td style="text-align:left"><code>SELECT ip_to_country(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_province(ip)</code></td>
<td style="text-align:left">判断 IP 所在的省份。</td>
<td style="text-align:left"><code>SELECT ip_to_province(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_city(ip)</code></td>
<td style="text-align:left">判断 IP 所在的城市。</td>
<td style="text-align:left"><code>SELECT ip_to_city(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_geo(ip)</code></td>
<td style="text-align:left">判断 IP 所在的城市的经纬度，范围结果格式为<code>纬度,经度</code>。</td>
<td style="text-align:left"><code>SELECT ip_to_geo(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_city_geo(ip)</code></td>
<td style="text-align:left">判断 IP 所在的城市的经纬度，返回的是城市经纬度，每个城市只有一个经纬度，范围结果格式为<code>纬度,经度</code>。</td>
<td style="text-align:left"><code>SELECT ip_to_city_geo(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_provider(ip)</code></td>
<td style="text-align:left">获取 IP 对应的网络运营商。</td>
<td style="text-align:left"><code>SELECT ip_to_provider(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_country(ip,'en')</code></td>
<td style="text-align:left">判断 IP 所在的国家，返回国家码。</td>
<td style="text-align:left"><code>SELECT ip_to_country(ip,'en')</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_country_code(ip)</code></td>
<td style="text-align:left">判断 IP 所在的国家，返回国家码。</td>
<td style="text-align:left"><code>SELECT ip_to_country_code(ip)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_province(ip,'en')</code></td>
<td style="text-align:left">判断 IP 所在的省份，返回英文省名或者中文拼音。</td>
<td style="text-align:left"><code>SELECT ip_to_province(ip,'en')</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ip_to_city(ip,'en')</code></td>
<td style="text-align:left">判断 IP 所在的城市，返回英文城市名或者中文拼音。</td>
<td style="text-align:left"><code>SELECT ip_to_city(ip,'en')</code></td>
</tr>
</tbody>
</table>
<h4 id="使用demo">使用demo</h4>
<ul>
<li>过滤掉内网请求，查看top10的网络访问省份</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">* | select count(1) as pv, ip_to_province(ip) as province   -- 判断省份</span><br><span class="line">where ip_to_domain(ip) != 'intranet'  <span class="comment">-- 过滤内网</span></span><br><span class="line">group by province  <span class="comment">-- 分组</span></span><br><span class="line">order by desc   <span class="comment">-- 降序</span></span><br><span class="line">limit 10  <span class="comment">-- 取出前10个</span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>查看不同国家的平均响应延时、最大响应延时以及最大延时对应的 request</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(latency),</span><br><span class="line">	   <span class="keyword">max</span>(latency),</span><br><span class="line">	   max_by(requestId, latency),</span><br><span class="line">	   ip_to_country(ip) <span class="keyword">as</span> country</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> country</span><br><span class="line"><span class="keyword">limit</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="地理函数">地理函数</h3>
<p>常用的地理函数包含：</p>
<ul>
<li>geohash(string)</li>
<li>geohash(lat, lon)</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">geohash(string)</td>
<td style="text-align:left">将纬度、经度用geohash编码，string为字符串类型，内容是纬度、逗号、经度。</td>
<td style="text-align:left"><code>select geohash('34.1,120.6')= 'wwjcbrdnzs'</code></td>
</tr>
<tr>
<td style="text-align:left">geohash(lat,lon)</td>
<td style="text-align:left">将纬度、经度用geohash编码，参数分别是纬度和经度。</td>
<td style="text-align:left"><code>select geohash(34.1,120.6)= 'wwjcbrdnzs'</code></td>
</tr>
</tbody>
</table>
<h3 id="Group-by用法">Group by用法</h3>
<p><code>GROUP BY</code> 支持多列。<code>GROUP BY</code>支持通过<code>SELECT</code>的列的别名来表示对应的<code>KEY</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(latency), projectName, date_trunc(<span class="string">'hour'</span>, __time__) <span class="keyword">as</span> <span class="keyword">hour</span>   <span class="comment">-- 取别名</span></span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> ProjectName, <span class="keyword">hour</span></span><br></pre></td></tr></table></figure>
<p><code>group by</code> 支持<code>grouping sets, cube, rollup</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">method:PostLogstoreLogs |<span class="keyword">select</span> <span class="keyword">avg</span>(latency)   <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">cube</span>(projectName,logstore)</span><br><span class="line">method:PostLogstoreLogs |<span class="keyword">select</span> <span class="keyword">avg</span>(latency)   <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">GROUPING</span> <span class="keyword">SETS</span> ( ( projectName,logstore), (projectName,method))</span><br><span class="line">method:PostLogstoreLogs |<span class="keyword">select</span> <span class="keyword">avg</span>(latency)   <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">rollup</span>(projectName,logstore)</span><br></pre></td></tr></table></figure>
<p>在group by中提取非agg列：如果使用了group by语法，那么在select时，只能选择select group by 的列原始内容，或者对任意列进行聚合计算，不允许获取非group by列的内容</p>
<p><strong>错误语法</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*| select a,b, count(c),group by a   -- b行由多个可供选择，系统不知道选择哪个</span><br></pre></td></tr></table></figure>
<p><strong>解决办法：使用arbitrary函数</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*| select a, arbitrary(b), count(c) group by a</span><br></pre></td></tr></table></figure>
<h3 id="窗口函数">窗口函数</h3>
<h4 id="窗口函数用处">窗口函数用处</h4>
<p>在日常工作中，经常会遇到需要<strong>在每组内排名</strong>，比如下面的业务需求：</p>
<blockquote>
<p>排名问题：每个部门按业绩来排名<br>
topN问题：找出每个部门排名前N的员工进行奖励</p>
</blockquote>
<p>面对这类需求，就需要使用sql的高级功能窗口函数了。</p>
<h4 id="什么是窗口函数">什么是窗口函数</h4>
<p>窗口函数，也叫OLAP函数（online anallytical processing，联合分析处理）。<strong>窗口函数是用来跨行计算的</strong>。普通的SQL聚合函数是只能用来处理计算一行内的结果，窗口函数可以跨行计算，并且把结果填到每行中</p>
<p><strong>基本语法</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;窗口函数&gt; over (partition by &lt;用于分组的列名&gt;</span><br><span class="line">            order by &lt;用于排序的列名&gt;)</span><br></pre></td></tr></table></figure>
<p>&lt;窗口函数&gt;的位置可以放置两种函数：</p>
<ol>
<li>专用窗口函数：rank、dense_rank、row_number</li>
<li>聚合函数：sum、avg、count、max、min</li>
</ol>
<blockquote>
<p>因为窗口函数是对where或者group by子句处理后的结果进行操作，所以<strong>窗口函数原则上只能写在select子句中</strong></p>
</blockquote>
<p><strong>使用demo</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> key1,key2,<span class="keyword">value</span></span><br><span class="line">	<span class="keyword">rank</span>() <span class="keyword">over</span> (pratition <span class="keyword">by</span> key2</span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">value</span> <span class="keyword">desc</span>) <span class="keyword">as</span> rnk</span><br><span class="line"><span class="keyword">from</span> orders</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> key1, rnk</span><br></pre></td></tr></table></figure>
<h4 id="函数">函数</h4>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">rank()</td>
<td style="text-align:left">在窗口内，按照某一列排序，返回在窗口内的序号。</td>
</tr>
<tr>
<td style="text-align:left">row_number()</td>
<td style="text-align:left">返回在窗口内的行号。</td>
</tr>
<tr>
<td style="text-align:left">first_value(x)</td>
<td style="text-align:left">返回窗口内的第一个value，一般用法是窗口内数值排序，获取最大值。</td>
</tr>
<tr>
<td style="text-align:left">last_value(x)</td>
<td style="text-align:left">含义和first value相反。</td>
</tr>
<tr>
<td style="text-align:left">nth_value(x, offset)</td>
<td style="text-align:left">窗口内的第offset个数。</td>
</tr>
<tr>
<td style="text-align:left">lead(x,offset,defaut_value)</td>
<td style="text-align:left">窗口内x列某行之后offset行的值，如果不存在该行，则取default_value。</td>
</tr>
<tr>
<td style="text-align:left">lag(x,offset,defaut_value)</td>
<td style="text-align:left">窗口内x列某行之前offset行的值，如果不存在该行，则取default_value。</td>
</tr>
</tbody>
</table>
<h4 id="demo-1">demo-1</h4>
<p>如果想对每个班级内按照成绩排名：</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge5449c779j30hl0d375d.jpg" alt=""></p>
<p>得到如下结果</p>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge544mrxuuj30hl0d6ta3.jpg" alt=""></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> *,</span><br><span class="line">	<span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> 班级  <span class="comment">-- rank()是排序的函数；同时对表分组</span></span><br><span class="line">                <span class="keyword">order</span> <span class="keyword">by</span> 成绩 <span class="keyword">desc</span>) <span class="keyword">as</span> ranking   <span class="comment">-- 对分组后的结果进行降序</span></span><br><span class="line"><span class="keyword">from</span> 班级表</span><br></pre></td></tr></table></figure>
<p>关键字：</p>
<ul>
<li>rank() over</li>
<li>partition by</li>
<li>order by</li>
</ul>
<p><img src="https://tva1.sinaimg.cn/large/007S8ZIlgy1ge5450o0v7j30hj0d4abg.jpg" alt=""></p>
<h4 id="demo-2">demo-2</h4>
<ul>
<li>查询在整个公司的人员中，获取每个人的薪水在部分内的排名</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> department, personId, sallary,</span><br><span class="line">      <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">Partition</span> <span class="keyword">by</span> department</span><br><span class="line">                  <span class="keyword">order</span> <span class="keyword">by</span> sallary <span class="keyword">desc</span>) <span class="keyword">as</span> sallary_rank</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> department, sallary_rank</span><br></pre></td></tr></table></figure>
<ul>
<li>在整个公司的人员中，获取每个人的薪水在部门中的占比</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> department, personId, sallery * <span class="number">1.0</span> / <span class="keyword">sum</span>(sallery) <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> department) <span class="keyword">as</span> sallary_percentage</span><br></pre></td></tr></table></figure>
<h3 id="having语法">having语法</h3>
<p>having用于过滤group by之后的聚合计算结果，where是在聚合计算之前过滤原始数据</p>
<h3 id="order-by语法">order by语法</h3>
<p>对输出结果进行排序</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">order by column [desc|asc]</span><br></pre></td></tr></table></figure>
<p><strong>实例demo</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">avg</span>(latency) <span class="keyword">as</span> avg_latency, projectName</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> projectName</span><br><span class="line"><span class="keyword">having</span> <span class="keyword">avg</span>(latency) &gt; <span class="number">570000</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> avg_latency <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure>
<h3 id="limit语法">limit语法</h3>
<h4 id="用法">用法</h4>
<p>用于限制输出结果的行数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">limit N   <span class="comment">-- 取前N行数据</span></span><br><span class="line">limit S, N  <span class="comment">-- 从S行开始，取出N行数据</span></span><br></pre></td></tr></table></figure>
<ul>
<li>不支持将<code>limit</code>语法用于子查询内部</li>
<li>翻页的<code>offset</code>不能超过1,000,000，即S+N必须小于1，000，000</li>
<li>N不能超过10,000</li>
</ul>
<h4 id="demo">demo</h4>
<ul>
<li>
<p>只获取100行结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* | select distinct(url) from log limit 100</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>获取0行到第999行的结果，共计1000行：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* | select distinct(url) from log limit 0,1000</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>获取第1000行到第1999行的结果，共计1000行：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">* | select distinct(url) from log limit 1000,1000</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="case-when语法">case when语法</h3>
<p><code>case when</code>语法对连续数据进行归类，例如从<code>http_user_agent</code>中提取信息，归类成<code>Android</code>和<code>ios</code>两种</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">case</span></span><br><span class="line"><span class="keyword">when</span> http_user_agent <span class="keyword">like</span> <span class="string">'%android%'</span> <span class="keyword">then</span> <span class="string">'andriod'</span>   <span class="comment">-- case的两个判断语法</span></span><br><span class="line"><span class="keyword">when</span> http_user_agent <span class="keyword">like</span> <span class="string">'%ios%'</span> <span class="keyword">then</span> <span class="string">'ios'</span></span><br><span class="line"><span class="keyword">else</span> <span class="string">'unknown'</span> <span class="keyword">end</span>  <span class="comment">-- else语句，end</span></span><br><span class="line"><span class="keyword">as</span> http_user_agent,</span><br><span class="line">	<span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> pv</span><br><span class="line">	<span class="keyword">group</span> <span class="keyword">by</span> http_user_agent</span><br></pre></td></tr></table></figure>
<p>计算不同延时区间的分布</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">case</span></span><br><span class="line"><span class="keyword">when</span> latency &lt; <span class="number">10</span> <span class="keyword">then</span> <span class="string">'s10'</span></span><br><span class="line"><span class="keyword">when</span> latency &lt; <span class="number">100</span> <span class="keyword">then</span> <span class="string">'s100'</span></span><br><span class="line"><span class="keyword">when</span> latency &lt; <span class="number">1000</span> <span class="keyword">then</span> <span class="string">'s1000'</span></span><br><span class="line"><span class="keyword">when</span> latency &lt; <span class="number">10000</span> <span class="keyword">then</span> <span class="string">'s10000'</span></span><br><span class="line"><span class="keyword">else</span> <span class="string">'s_large'</span> <span class="keyword">end</span></span><br><span class="line"><span class="keyword">as</span> latency_slot,</span><br><span class="line"><span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> pv</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> latency_slot</span><br></pre></td></tr></table></figure>
<h3 id="if语法">if语法</h3>
<p><code>if</code>语法逻辑上等同于<code>case when</code>语法</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">case</span><br><span class="line">	when condition then true_value</span><br><span class="line">	[ else false_value]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>if(condition, true_value)</code></li>
</ul>
<p>如果<code>condition</code> 是<code>true</code>，返回<code>true_value</code>，否则返回的是<code>NULL</code></p>
<ul>
<li><code>if(condition, true_value, false_value)</code></li>
</ul>
<p>如果<code>condition</code> 是<code>true</code>，返回<code>true_value</code>，否则返回的是<code>false_value</code></p>
<h3 id="coalesce语法">coalesce语法</h3>
<p>返回的是多个列的<strong>第一个非NULL值</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">coalesce(value1,value2,...)</span><br></pre></td></tr></table></figure>
<h3 id="nullif语法">nullif语法</h3>
<p>如果<code>value1</code>和<code>value2</code>相等，返回的是<code>NULL</code>；否则返回的是<code>value1</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nullif(value1,value2)    <span class="comment">-- 如果value1和value2相等，返回的是NULL；否则返回的是value1</span></span><br></pre></td></tr></table></figure>
<h3 id="二进制字符串函数">二进制字符串函数</h3>
<p><strong>二进制字符串类型</strong><code>varbinary</code>有别于字符串类型<code>varchar</code></p>
<ul>
<li>|| ：连接函数，等同于concat函数</li>
<li>to/from_base64</li>
<li>to/from_base64url</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">语句</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">连接函数 ||</td>
<td style="text-align:left"><code>a || b</code> 结果为<code>ab</code>。</td>
</tr>
<tr>
<td style="text-align:left">length(binary) → bigint</td>
<td style="text-align:left">返回二进制的长度。</td>
</tr>
<tr>
<td style="text-align:left">concat(binary1, …, binaryN) → varbinary</td>
<td style="text-align:left">连接二进制字符串，等同于||。</td>
</tr>
<tr>
<td style="text-align:left">to_base64(binary) → varchar</td>
<td style="text-align:left">把二进制字符串转换成base64。</td>
</tr>
<tr>
<td style="text-align:left">from_base64(string) → varbinary</td>
<td style="text-align:left">把base64转换成二进制字符串。</td>
</tr>
<tr>
<td style="text-align:left">to_base64url(binary) → varchar</td>
<td style="text-align:left">转化成url安全的base64。</td>
</tr>
<tr>
<td style="text-align:left">from_base64url(string) → varbinary</td>
<td style="text-align:left">从url安全的base64转化成二进制字符串。</td>
</tr>
<tr>
<td style="text-align:left">to_hex(binary) → varchar</td>
<td style="text-align:left">把二进制字符串转化成十六进制表示。</td>
</tr>
<tr>
<td style="text-align:left">from_hex(string) → varbinary</td>
<td style="text-align:left">从十六进制转化成二进制。</td>
</tr>
<tr>
<td style="text-align:left">to_big_endian_64(bigint) → varbinary</td>
<td style="text-align:left">把数字转化成大端表示的二进制。</td>
</tr>
<tr>
<td style="text-align:left">from_big_endian_64(binary) → bigint</td>
<td style="text-align:left">把大端表示的二进制字符串转化成数字。</td>
</tr>
<tr>
<td style="text-align:left">md5(binary) → varbinary</td>
<td style="text-align:left">计算二进制字符串的md5。</td>
</tr>
<tr>
<td style="text-align:left">sha1(binary) → varbinary</td>
<td style="text-align:left">计算二进制字符串的sha1。</td>
</tr>
<tr>
<td style="text-align:left">sha256(binary) → varbinary</td>
<td style="text-align:left">计算二进制字符串的sha256 hash。</td>
</tr>
<tr>
<td style="text-align:left">sha512(binary) → varbinary</td>
<td style="text-align:left">计算二进制字符串的sha512。</td>
</tr>
<tr>
<td style="text-align:left">xxhash64(binary) → varbinary</td>
<td style="text-align:left">计算二进制字符串的xxhash64。</td>
</tr>
</tbody>
</table>
<h3 id="位运算">位运算</h3>
<table>
<thead>
<tr>
<th style="text-align:left">语句</th>
<th style="text-align:left">说明</th>
<th style="text-align:left">示例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">bit_count(x, bits) → bigint</td>
<td style="text-align:left">统计x的二进制表示中，1的个数。</td>
<td style="text-align:left"><code>SELECT bit_count(9, 64); — 2</code><br /><code>SELECT bit_count(9, 8); — 2</code><br /><code>SELECT bit_count(-7, 64); — 62</code><br /><code>SELECT bit_count(-7, 8); — 6</code></td>
</tr>
<tr>
<td style="text-align:left">bitwise_and(x, y) → bigint</td>
<td style="text-align:left">以二进制的形式求x,y的and的值。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">bitwise_not(x) → bigint</td>
<td style="text-align:left">以二进制的形式求对x的所有位取反。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">bitwise_or(x, y) → bigint</td>
<td style="text-align:left">以二进制形式对x，y求or。</td>
<td style="text-align:left">-</td>
</tr>
<tr>
<td style="text-align:left">bitwise_xor(x, y) → bigint</td>
<td style="text-align:left">以二进制形式对x，y求xor。</td>
<td style="text-align:left">-</td>
</tr>
</tbody>
</table>
<h3 id="同比和环比函数">同比和环比函数</h3>
<p>比和环比函数用于比较当前区间的计算结果和之前一个指定区间的结果</p>
<table>
<thead>
<tr>
<th style="text-align:left">函数</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>compare(value, time_window)</code></td>
<td style="text-align:left">表示将当前时段计算出来的value值和time_window计算出来的结果进行比较。value为double或long类型，time_window单位为秒；返回值为数组类型。返回值分别是当前值、time_window之前的值和当前值与之前值的比值。</td>
<td style="text-align:left"><code>*|select compare( pv , 86400) from (select count(1) as pv from log)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>compare(value, time_window1, time_window2)</code></td>
<td style="text-align:left">表示当前区间分别和time_window1和time_window2之前的区间值进行比较，结果为json数组。其中，各个值的大小必须满足以下规则：[当前值，time_window1之前的值，time_window2之前的值，当前值/time_window1之前的值，当前值/time_window2之前的值]。</td>
<td style="text-align:left"><code>* | select compare(pv, 86400, 172800) from ( select count(1) as pv from log)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>compare(value, time_window1, time_window2, time_window3)</code></td>
<td style="text-align:left">表示当前区间分别和time_window1和time_window2，time_window3之前的区间值进行比较，结果为json数组。其中，各个值的大小必须满足以下规则：[当前值，time_window1之前的值，time_window2之前的值，time_window3之前的值，当前值/time_window1之前的值，当前值/time_window2之前的值，当前值/time_window3之前的值]。</td>
<td style="text-align:left"><code>* | select compare(pv, 86400, 172800,604800) from ( select count(1) as pv from log)</code></td>
</tr>
<tr>
<td style="text-align:left"><code>ts_compare(value, time_window)</code></td>
<td style="text-align:left">表示当前区间分别和<code>time_window1</code>和<code>time_window2</code>之前的区间值进行比较，结果为json数组。其中，各个值的大小必须遵循以下规则：[当前值，time_window1之前的值，当前值/time_window1之前的值，前一个时间起点的unix时间戳]。用于时序函数比较，需要在SQL中对时间列进行GROUP BY。</td>
<td style="text-align:left">例如，<code>* | select t, ts_compare(pv, 86400 ) as d from(select date_trunc('minute',__time__ ) as t, count(1) as pv from log group by t order by t ) group by t</code>表示将当前时间段每分钟的计算结果和上一个时间段每分钟的计算结果进行比较。结果为：<code>d:[1251.0,1264.0, 0.9897151898734177, 1539843780.0,1539757380.0]t:2018-10-19 14:23:00.000</code>。</td>
</tr>
</tbody>
</table>
<h4 id="demo-1-v2">demo-1</h4>
<p>计算当前<code>1</code>小时和昨天同一个时间段的<code>PV</code>比例</p>
<blockquote>
<p>笔记：<code>PV（PageView）</code> 页面点击量，每次刷新就算一次浏览，多次打开同一页面会累加</p>
</blockquote>
<p>开始时间为2020-03-25 14:00:00；结束时间为2020-03-25 15:00:00。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> compare(pv, <span class="number">86400</span>) <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> pv <span class="keyword">from</span> <span class="keyword">log</span>)   <span class="comment">-- 86400表示当前时间段减去86400秒</span></span><br></pre></td></tr></table></figure>
<p>假设结果为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[9.0,19.0,0.47368421052631579]</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>9：03-25的14:00:00到15:00:00的PV值</li>
<li>19：03-24的14:00到03-25的14:00的PV值</li>
<li>0.47368421052631579：表示当前时间段与之前时间段的比值</li>
</ul>
<p>将数组展开成3列的写法为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> diff[<span class="number">1</span>], diff[<span class="number">2</span>], diff[<span class="number">3</span>]</span><br><span class="line"><span class="keyword">from</span> <span class="keyword">select</span>(compare(pv, <span class="number">86400</span>) <span class="keyword">as</span> diff</span><br><span class="line">            <span class="keyword">from</span> (<span class="keyword">select</span> <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> pv</span><br><span class="line">                  <span class="keyword">from</span> <span class="keyword">log</span>))</span><br></pre></td></tr></table></figure>
<h3 id="比较函数和运算符">比较函数和运算符</h3>
<p>比较运算判断参数的大小，可以适用于任何可比类型，例如：<code>int、bigint、double、text</code>等</p>
<h4 id="比较运算符">比较运算符</h4>
<p>当用比较运算符比较两个值得时候，如果逻辑成立，则表示为True，否则返回False</p>
<table>
<thead>
<tr>
<th style="text-align:left">运算符</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">&lt;</td>
<td style="text-align:left">小于</td>
</tr>
<tr>
<td style="text-align:left">&gt;</td>
<td style="text-align:left">大于</td>
</tr>
<tr>
<td style="text-align:left">&lt;=</td>
<td style="text-align:left">小于或等于</td>
</tr>
<tr>
<td style="text-align:left">&gt;=</td>
<td style="text-align:left">大于或等于</td>
</tr>
<tr>
<td style="text-align:left">=</td>
<td style="text-align:left">等于</td>
</tr>
<tr>
<td style="text-align:left">&lt;&gt;</td>
<td style="text-align:left">不等于</td>
</tr>
<tr>
<td style="text-align:left">!=</td>
<td style="text-align:left">不等于</td>
</tr>
</tbody>
</table>
<h4 id="范围运算符-BETWEEN">范围运算符 BETWEEN</h4>
<p><code>between</code>用于判断一个参数的值是否在另外两个参数之间，范围为闭区间。</p>
<ul>
<li>
<p>如果逻辑成立，则返回true；否则返回false。</p>
<p>示例：<code>SELECT 3 BETWEEN 2 AND 6;</code>逻辑成立，返回true。</p>
<p>以上样例等同于<code>SELECT 3 &gt;= 2 AND 3 &lt;= 6;</code></p>
</li>
<li>
<p>BETWEEN可以跟在not之后，用于相反逻辑的判断。</p>
<p>示例：<code>SELECT 3 NOT BETWEEN 2 AND 6;</code>，逻辑不成立，返回false。</p>
<p>以上样例等同于<code>SELECT 3 &lt; 2 OR 3 &gt; 6;</code></p>
</li>
<li>
<p>如果三个参数中任何一个包含Null，则返回的结果为Null。</p>
</li>
</ul>
<h4 id="IS-NULL-和-IS-NOT-NULL">IS NULL 和 IS NOT NULL</h4>
<p>用于判断参数是否为<code>NULL</code>值</p>
<h4 id="GREATEST-和-LEAST">GREATEST 和 LEAST</h4>
<p>用于获取多列中的最大值或者最小值</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">greatest</span>(<span class="number">1</span>,<span class="number">3</span>,<span class="number">4</span>)   <span class="comment">-- 返回的是4</span></span><br></pre></td></tr></table></figure>
<h4 id="比较判断：all、any、some">比较判断：all、any、some</h4>
<p>比较判断用于判断参数是否满足条件</p>
<ul>
<li>all：用于判断参数是否满足条件</li>
<li>any：用于判断是否满足条件之一</li>
<li>some：判断参数是否满足条件之一，同<code>any</code>的用法相同</li>
</ul>
<p><strong>三者必须紧跟在比较运算符之后</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">表达式</th>
<th style="text-align:left">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">A = ALL (…)</td>
<td style="text-align:left">A等于所有的值时，结果才是true。</td>
</tr>
<tr>
<td style="text-align:left">A &lt;&gt; ALL (…)</td>
<td style="text-align:left">A不等于所有的值时，结果才是true。</td>
</tr>
<tr>
<td style="text-align:left">A &lt; ALL (…)</td>
<td style="text-align:left">A小于所有的值时，结果才是true。</td>
</tr>
<tr>
<td style="text-align:left">A = ANY (…)</td>
<td style="text-align:left">A等于任何一个值时，结果就为true，等同于 A IN (…)。</td>
</tr>
<tr>
<td style="text-align:left">A &lt;&gt; ANY (…)</td>
<td style="text-align:left">A不等于任何一个值时，结果为true。</td>
</tr>
<tr>
<td style="text-align:left">A &lt; ANY (…)</td>
<td style="text-align:left">A小于其中最大值时，结果为true。</td>
</tr>
</tbody>
</table>
<p>看几个例子</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="string">'hello'</span> = <span class="keyword">any</span> (<span class="keyword">values</span> <span class="string">'hello'</span>, <span class="string">'world'</span>)    <span class="comment">-- true，只要满足一个</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">21</span> &lt; <span class="keyword">all</span> (<span class="keyword">values</span> <span class="number">19</span>,<span class="number">20</span>,<span class="number">21</span>)  <span class="comment">-- false，需要全部满足</span></span><br><span class="line"><span class="keyword">select</span> <span class="number">42</span> &gt;= <span class="keyword">some</span>(<span class="keyword">select</span> <span class="number">41</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">42</span> <span class="keyword">union</span> <span class="keyword">all</span> <span class="keyword">select</span> <span class="number">43</span>);  <span class="comment">-- true</span></span><br></pre></td></tr></table></figure>
<h3 id="Lambda表达式">Lambda表达式</h3>
<p>lambda匿名函数的基本形式为<code>-&gt;</code></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">x -&gt; x + 1</span><br><span class="line">(x, y) -&gt; x + y</span><br><span class="line">x -&gt; regexp_like(x, 'a+')</span><br><span class="line">x -&gt; x[1] / x[2]</span><br><span class="line">x -&gt; IF(x &gt; 0, x, -x)</span><br><span class="line">x -&gt; COALESCE(x, 0)</span><br><span class="line">x -&gt; CAST(x AS JSON)</span><br><span class="line">x -&gt; x + TRY(1 / 0)</span><br></pre></td></tr></table></figure>
<h4 id="filter">filter</h4>
<p>基本格式：<code>filter(array&lt;T&gt;, function&lt;T,boolean) ---&gt;array&lt;T&gt;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> filter (<span class="built_in">array</span> [], x -&gt; <span class="literal">true</span>);   <span class="comment">-- []</span></span><br><span class="line"><span class="keyword">select</span> filter (<span class="built_in">array</span> [<span class="number">5</span>, <span class="number">-6</span>, <span class="literal">null</span>, <span class="number">7</span>], x -&gt; x &gt;<span class="number">0</span>);  <span class="comment">--[5,7]</span></span><br><span class="line"><span class="keyword">select</span> filter (<span class="built_in">array</span> [<span class="number">5</span>,<span class="literal">null</span>,<span class="number">7</span>,<span class="literal">null</span>], x -&gt; x <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>);  <span class="comment">-- [5,7]</span></span><br></pre></td></tr></table></figure>
<h4 id="map-filter">map_filter</h4>
<p>从<code>map</code>中过滤数据，只获取满足<code>function</code>且返回<code>true</code>的<strong>元素对</strong></p>
<p>基本语法格式：<code>map_filter(map&lt;K, V&gt;, function&lt;K, V, boolean&gt;) → MAP&lt;K,V&gt;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> map_filter(<span class="keyword">MAP</span>(<span class="built_in">ARRAY</span>[], <span class="built_in">ARRAY</span>[]), (k, v) -&gt; <span class="literal">true</span>); <span class="comment">-- &#123;&#125;</span></span><br><span class="line"><span class="keyword">SELECT</span> map_filter(<span class="keyword">MAP</span>(<span class="built_in">ARRAY</span>[<span class="number">10</span>, <span class="number">20</span>, <span class="number">30</span>], <span class="built_in">ARRAY</span>[<span class="string">'a'</span>, <span class="literal">NULL</span>, <span class="string">'c'</span>]), (k, v) -&gt; v <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>); <span class="comment">-- &#123;10 -&gt; a, 30 -&gt; c&#125;</span></span><br><span class="line"><span class="keyword">SELECT</span> map_filter(<span class="keyword">MAP</span>(<span class="built_in">ARRAY</span>[<span class="string">'k1'</span>, <span class="string">'k2'</span>, <span class="string">'k3'</span>], <span class="built_in">ARRAY</span>[<span class="number">20</span>, <span class="number">3</span>, <span class="number">15</span>]), (k, v) -&gt; v &gt; <span class="number">10</span>); <span class="comment">-- &#123;k1 -&gt; 20, k3 -&gt; 15&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="reduce">reduce</h4>
<p>基本语法格式为：<code>reduce(array&lt;T&gt;, initialState S, inputFunction&lt;S, T, S&gt;, outputFunction&lt;S, R&gt;) → R</code></p>
<p><strong>详细步骤为</strong></p>
<ol>
<li>初始状态S</li>
<li>遍历每个元素T</li>
<li>计算<code>inputFunction(S,T)</code>，生成新状态S</li>
<li>重复步骤2~步骤3，直到最后一个元素被遍历以及生成新状态</li>
<li>利用最终状态S，获取最终输出结果R</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> reduce(<span class="built_in">array</span> [], (s, x) -&gt; s+x, s -&gt; s);   <span class="comment">-- 0</span></span><br><span class="line"><span class="keyword">select</span> reduce(<span class="built_in">array</span> [<span class="number">5</span>,<span class="number">20</span>,<span class="number">50</span>], (s, x) -&gt; s+x, s -&gt; s);   <span class="comment">-- 75</span></span><br><span class="line"><span class="keyword">select</span> reduce(<span class="built_in">array</span> [<span class="number">5</span>,<span class="number">20</span>,<span class="literal">null</span>,<span class="number">50</span>], (s, x) -&gt; s+x, s -&gt; s);   <span class="comment">-- null，任何数加上NULL都是NULL</span></span><br><span class="line"><span class="keyword">select</span> reduce(<span class="built_in">array</span> [<span class="number">5</span>,<span class="number">20</span>,<span class="literal">null</span>,<span class="number">50</span>], (s, x) -&gt; s + <span class="keyword">coalesce</span>(x,<span class="number">0</span>), s -&gt; s);  <span class="comment">-- 75; coalesce返回的是多个列的第一个非NULL值</span></span><br></pre></td></tr></table></figure>
<h4 id="transform">transform</h4>
<p>基本语法：<code>transform(array&lt;T&gt;, function&lt;T, U&gt;) → ARRAY&lt;U&gt;</code></p>
<p>对数组中的每个元素，一次调用<code>function</code>，生成新的结果<code>U</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> transform(<span class="built_in">array</span> [], x -&gt; x+<span class="number">1</span>);   <span class="comment">--[]</span></span><br><span class="line"><span class="keyword">select</span> transform(<span class="built_in">array</span> [<span class="number">5</span>,<span class="number">6</span>], x -&gt; x+<span class="number">1</span>);   <span class="comment">-- [6,7]</span></span><br><span class="line"><span class="keyword">select</span> transform(<span class="built_in">array</span> [<span class="number">5</span>,<span class="literal">null</span>,<span class="number">6</span>], x -&gt; <span class="keyword">coalesce</span>(x,<span class="number">0</span>) + <span class="number">1</span>);  <span class="comment">-- [6,1,7]</span></span><br></pre></td></tr></table></figure>
<h4 id="zip-with">zip_with</h4>
<p>基本语法格式：<code>zip_with(array&lt;T&gt;, array&lt;U&gt;, function&lt;T, U, R&gt;) → array&lt;R&gt;</code></p>
<p>将两个<code>array</code>合并，根据元素<code>T、U</code>，通过函数生成新的<code>array</code>中的元素R</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> zip_with(<span class="built_in">ARRAY</span>[<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>], <span class="built_in">ARRAY</span>[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], (x, y) -&gt; (y, x)); <span class="comment">--调换前后两个数组的元素位置，生成新的数组:[['a', 1], ['b', 3],['c', 5]]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> zip_with(<span class="built_in">ARRAY</span>[<span class="number">1</span>, <span class="number">2</span>], <span class="built_in">ARRAY</span>[<span class="number">3</span>, <span class="number">4</span>], (x, y) -&gt; x + y); <span class="comment">-- 对应位置上的元素相加，结果[4, 6]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span> zip_with(<span class="built_in">ARRAY</span>[<span class="string">'a'</span>, <span class="string">'b'</span>, <span class="string">'c'</span>], <span class="built_in">ARRAY</span>[<span class="string">'d'</span>, <span class="string">'e'</span>, <span class="string">'f'</span>], (x, y) -&gt; <span class="keyword">concat</span>(x, y)); <span class="comment">-- 把前后两个数组的元素拼接，生成新的字符串：['ad', 'be', 'cf']</span></span><br></pre></td></tr></table></figure>
<h3 id="逻辑函数">逻辑函数</h3>
<h4 id="运算符">运算符</h4>
<table>
<thead>
<tr>
<th style="text-align:left">运算符</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">AND</td>
<td style="text-align:left">只有左右运算数都是true时，结果才为true</td>
<td style="text-align:left">a AND b</td>
</tr>
<tr>
<td style="text-align:left">OR</td>
<td style="text-align:left">左右运算数任一个为true，结果为true</td>
<td style="text-align:left">a OR b</td>
</tr>
<tr>
<td style="text-align:left">NOT</td>
<td style="text-align:left">右侧运算数为false时，结果才为true</td>
<td style="text-align:left">NOT a</td>
</tr>
</tbody>
</table>
<h4 id="NULL参与逻辑运算符">NULL参与逻辑运算符</h4>
<p>重点标记的一种情况</p>
<table>
<thead>
<tr>
<th style="text-align:left">a</th>
<th style="text-align:left">b</th>
<th style="text-align:left">a AND b</th>
<th style="text-align:left">a OR b</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">TRUE</td>
</tr>
<tr>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">TRUE</td>
</tr>
<tr>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">TRUE</td>
</tr>
<tr>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">TRUE</td>
</tr>
<tr>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">FALSE</td>
</tr>
<tr>
<td style="text-align:left"><strong>FALSE</strong></td>
<td style="text-align:left"><strong>NULL</strong></td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left"><strong>NULL</strong></td>
</tr>
<tr>
<td style="text-align:left">NULL</td>
<td style="text-align:left">TRUE</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">TRUE</td>
</tr>
<tr>
<td style="text-align:left">NULL</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">FALSE</td>
<td style="text-align:left">NULL</td>
</tr>
<tr>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">NULL</td>
</tr>
</tbody>
</table>
<h3 id="join">join</h3>
<p><code>SQL</code>中常用的4个<code>join</code>用法</p>
<ul>
<li>inner join</li>
<li>left (outer) join</li>
<li>right (outer) join</li>
<li>full outer join</li>
</ul>
<p><strong>牢记此图</strong>！</p>
<p><strong>牢记此图</strong>！</p>
<p><strong>牢记此图</strong>!</p>
<p><img src="https://upload-images.jianshu.io/upload_images/5142014-1e5e233af576382c.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1200/format/webp" alt="img"></p>
<p>以下面的两个表格为例子：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM Table_A ORDER BY PK ASC;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| PK | Value   |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  1 | both ab |</span><br><span class="line">|  2 | only a  |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SELECT</span> * <span class="keyword">from</span> Table_B <span class="keyword">ORDER</span> <span class="keyword">BY</span> PK <span class="keyword">ASC</span>;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| PK | Value   |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  1 | both ab |</span><br><span class="line">|  3 | only b  |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
<h4 id="inner-join">inner join</h4>
<p><strong>内连接</strong>，将左右两个表中能够关联的数据连接起来，并返回出结果；PK为公共字段</p>
<p><strong>必须要有共同的字段！！！</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> A.PK <span class="keyword">AS</span> A_PK, B.PK <span class="keyword">AS</span> B_PK,</span><br><span class="line">       A.Value <span class="keyword">AS</span> A_Value, B.Value <span class="keyword">AS</span> B_Value</span><br><span class="line"><span class="keyword">FROM</span> Table_A A</span><br><span class="line"><span class="keyword">INNER</span> <span class="keyword">JOIN</span> Table_B B</span><br><span class="line"><span class="keyword">ON</span> A.PK = B.PK;</span><br></pre></td></tr></table></figure>
<h4 id="left-outer-join">left (outer) join</h4>
<p><strong>左连接，返回左边表的全部记录</strong>，不管右表中有没有关联的数据。在右表中找到的关联数据列一并返回</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> A.PK <span class="keyword">as</span> A_PK,B.PK <span class="keyword">as</span> B_PK,   <span class="comment">-- 字段取别名</span></span><br><span class="line">       A.Value <span class="keyword">as</span> A_Value, B.Value <span class="keyword">as</span> B_Value</span><br><span class="line"><span class="keyword">From</span> Table_A A  <span class="comment">-- 表取别名</span></span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> Table_B B</span><br><span class="line"><span class="keyword">on</span> A.PK = B.PK;</span><br></pre></td></tr></table></figure>
<h4 id="right-outer-join">right (outer) join</h4>
<p><strong>右连接，返回右边表的全部记录</strong>，不管左表中有没有关联的数据。在左表中找到的关联数据列一并返回</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> A.PK <span class="keyword">as</span> A_PK,B.PK <span class="keyword">as</span> B_PK,   <span class="comment">-- 字段取别名</span></span><br><span class="line">       A.Value <span class="keyword">as</span> A_Value, B.Value <span class="keyword">as</span> B_Value</span><br><span class="line"><span class="keyword">From</span> Table_A A  <span class="comment">-- 表取别名</span></span><br><span class="line"><span class="keyword">right</span> <span class="keyword">join</span> Table_B B</span><br><span class="line"><span class="keyword">on</span> A.PK = B.PK;</span><br></pre></td></tr></table></figure>
<h4 id="full-outer-join">full (outer) join</h4>
<p>常被称作<strong>外连接，全连接</strong>。外连接查询能返回左右表里的所有记录，其中左右表里能关联起来的记录被连接后返回。</p>
<blockquote>
<p>mysql中目前没有full join功能</p>
</blockquote>
<h3 id="unnest语法">unnest语法</h3>
<h4 id="背景">背景</h4>
<p>在复杂的业务场景下，日志数据的某一列可能会是较为复杂的格式，例如数组（array）、对象(map)、JSON等格式。对这种特殊格式的日志字段进行查询分析，可以使用unnest语法。</p>
<h4 id="语法结构">语法结构</h4>
<p><strong>unnest接收的是array或者map类型</strong></p>
<p>如果输入的是字符串类型，要先转成json类型，再转化成array类型或者map类型，转化格式：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cast(json_parse(array_column) as array(biginit))</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:left">语法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"><code>unnest( array) as table_alias(column_name)</code></td>
<td style="text-align:left">表示把array类型展开成多行，<strong>行的名称</strong>为<code>column_name</code>。</td>
</tr>
<tr>
<td style="text-align:left"><code>unnest(map) as table(key_name, value_name)</code></td>
<td style="text-align:left">表示把map类型展开成多行，key的名称为<code>key_name</code>，value的名称为<code>value_name</code>。</td>
</tr>
</tbody>
</table>
<h4 id="遍历数组的每个元素">遍历数组的每个元素</h4>
<ol>
<li>展开数组</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> array_column, a <span class="keyword">from</span> <span class="keyword">log</span>,  <span class="comment">-- 展开每个元素</span></span><br><span class="line"><span class="keyword">unnest</span>(<span class="keyword">cast</span>(json_parse(array_column) <span class="keyword">as</span> <span class="built_in">array</span>(<span class="built_in">bigint</span>))) <span class="keyword">as</span> t(a)  <span class="comment">-- 以t来命名新表，使用a来引用展开后的列</span></span><br></pre></td></tr></table></figure>
<ol start="2">
<li>数组求和</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sum</span>(a) <span class="keyword">from</span> <span class="keyword">log</span>,   <span class="comment">-- 求和</span></span><br><span class="line"><span class="keyword">unnest</span>(<span class="keyword">cast</span>(json_parse(array_column) <span class="keyword">as</span> <span class="built_in">array</span>(<span class="built_in">bigint</span>))) <span class="keyword">as</span> t(a)</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>利用 group by 进行分组</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> a, <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">from</span> <span class="keyword">log</span>,</span><br><span class="line"><span class="keyword">unnest</span>(<span class="keyword">cast</span>(json_parse(array_num) <span class="keyword">as</span> <span class="built_in">array</span>(<span class="built_in">bigint</span>))) <span class="keyword">as</span> t(a)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> a</span><br></pre></td></tr></table></figure>
<h4 id="遍历map">遍历map</h4>
<ol>
<li>遍历map中的元素</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> map_column,a,b <span class="keyword">from</span> <span class="keyword">log</span>,</span><br><span class="line"><span class="keyword">unnest</span>(<span class="keyword">cast</span>(json_parse(map_column) <span class="keyword">as</span> <span class="keyword">map</span>(<span class="built_in">varchar</span>, <span class="built_in">bigint</span>))) <span class="keyword">as</span> t(a,b)</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>按照map的key进行统计</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">key</span>, <span class="keyword">sum</span>(<span class="keyword">value</span>) <span class="keyword">from</span> <span class="keyword">log</span>,</span><br><span class="line"><span class="keyword">unnest</span>(<span class="keyword">cast</span>(json_parse(map_column) <span class="keyword">as</span> <span class="keyword">map</span>(<span class="built_in">varchar</span>, <span class="built_in">bigint</span>))) <span class="keyword">as</span> t(<span class="keyword">key</span>, <span class="keyword">value</span>)</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">key</span>;</span><br></pre></td></tr></table></figure>
<h4 id="格式化显示histogram-numeric-histogram">格式化显示histogram,numeric_histogram</h4>
<h5 id="histogram">histogram</h5>
<p><code>histogram</code>函数类似于 <code>count group by</code> 语法，其结果通常是一连串的json数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">key</span>, <span class="keyword">value</span> <span class="keyword">from</span> (<span class="keyword">select</span> histogram(method) <span class="keyword">as</span> his <span class="keyword">from</span> <span class="keyword">log</span>),</span><br><span class="line"><span class="keyword">unnest</span>(his) <span class="keyword">as</span> t(<span class="keyword">key</span>,<span class="keyword">value</span>)</span><br></pre></td></tr></table></figure>
<h5 id="numeric-histogram">numeric_histogram</h5>
<p><code>numeric_histogram</code>语法是将数值列分配到多个桶中去，相当于是对数值列进行group by</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">key</span>,<span class="keyword">value</span> <span class="keyword">from</span> (<span class="keyword">select</span> numeric_histogram(<span class="number">10</span>, Latency) <span class="keyword">as</span> his <span class="keyword">from</span> <span class="keyword">log</span>),</span><br><span class="line"><span class="keyword">unnest</span>(his) <span class="keyword">as</span> t(<span class="keyword">key</span>,<span class="keyword">value</span>)</span><br></pre></td></tr></table></figure>
<h3 id="电话号码函数">电话号码函数</h3>
<p>电话号码函数提供对中国内地区域电话号码的归属地查询功能</p>
<h4 id="函数列表">函数列表</h4>
<ul>
<li>mobile_province：省份</li>
<li>mobile_city：城市</li>
<li>mobile_carrier：运营商</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">函数名</th>
<th style="text-align:left">含义</th>
<th style="text-align:left">样例</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">mobile_province</td>
<td style="text-align:left">查看电话号码<strong>所属省份</strong>，需要传入电话的数字形式。字符串参数可以使用<code>try_cast</code>进行转换。</td>
<td style="text-align:left"><code>* | select mobile_province(12345678)``* \| select mobile_province(try_cast('12345678' as bigint) )</code></td>
</tr>
<tr>
<td style="text-align:left">mobile_city</td>
<td style="text-align:left">查看电话号码<strong>所属城市</strong>，需要传入电话的数字形式。字符串参数可以使用<code>try_cast</code>进行转换。</td>
<td style="text-align:left"><code>* | select mobile_city(12345678)``* \| select mobile_city(try_cast('12345678' as bigint) )</code></td>
</tr>
<tr>
<td style="text-align:left">mobile_carrier</td>
<td style="text-align:left">查看电话号码<strong>所属运营商</strong>，需要传入电话的数字形式。字符串参数可以使用<code>try_cast</code>进行转换。</td>
<td style="text-align:left"><code>* | select mobile_carrier(12345678)``* \| select mobile_carrier(try_cast('12345678' as bigint) )</code></td>
</tr>
</tbody>
</table>
<h4 id="demo-v2">demo</h4>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> mobile_city(<span class="keyword">try_cast</span>(<span class="string">"mobile"</span> <span class="keyword">as</span> <span class="built_in">bigint</span>)) <span class="keyword">as</span> <span class="string">"城市"</span>,   <span class="comment">-- try_cast将字符串转成数值型</span></span><br><span class="line">       mobile_province(<span class="keyword">try_cast</span>(<span class="string">"mobile"</span> <span class="keyword">as</span> <span class="built_in">bigint</span>)) asd <span class="string">"省份"</span>,</span><br><span class="line">       <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> <span class="string">"请求次数"</span></span><br><span class="line">       <span class="keyword">group</span> <span class="keyword">by</span> <span class="string">"省份"</span>, <span class="string">"城市"</span></span><br><span class="line">       <span class="keyword">order</span> <span class="keyword">by</span> <span class="string">"请求次数"</span> <span class="keyword">desc</span></span><br><span class="line">       <span class="keyword">limit</span> <span class="number">1000</span></span><br><span class="line">       )</span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

<div>
      
        
<div class="my_post_copyright">
  <script src="//cdn.bootcss.com/clipboard.js/1.5.10/clipboard.min.js"></script>
  
  <!-- JS库 sweetalert 可修改路径 -->
  <script src="https://cdn.bootcss.com/jquery/2.0.0/jquery.min.js"></script>
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
  <p><span>本文标题:</span><a href="/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html">SQL内置函数手册</a></p>
  <p><span>发布时间:</span>2020年04月24日 - 19:04</p>
  <p><span>原始链接:</span><a href="/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html" title="SQL内置函数手册">http://www.renpeter.cn/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html</a>
    <span class="copy-path"  title="点击复制文章链接"><i class="fa fa-clipboard" data-clipboard-text="http://www.renpeter.cn/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html"  aria-label="复制成功！"></i></span>
  </p>
  <p><span>许可协议:</span><i class="fa fa-creative-commons"></i> <a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank" title="Attribution-NonCommercial-NoDerivatives 4.0 International (CC BY-NC-ND 4.0)">署名-非商业性使用-禁止演绎 4.0 国际</a> 转载请保留原文链接及作者。</p>  
</div>
<script> 
    var clipboard = new Clipboard('.fa-clipboard');
	  $(".fa-clipboard").click(function(){
      clipboard.on('success', function(){
        swal({   
          title: "",   
          text: '复制成功',
          icon: "success", 
          showConfirmButton: true
          });
	    });
    });  
</script>

      
</div>


    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Coffee or Tea</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>Donate</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="PiQianChao WeChat Pay"/>
        <p>WeChat Pay</p>
      </div>
    

    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag"># 数据库</a>
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/04/24/%E9%98%85%E8%AF%BB%E7%BB%99%E4%BD%A0%E5%8F%A6%E4%B8%80%E4%B8%AA%E4%B8%96%E7%95%8C.html" rel="next" title="阅读给你另一个世界">
                <i class="fa fa-chevron-left"></i> 阅读给你另一个世界
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/04/25/%E6%97%A5%E5%BF%97%E6%9C%8D%E5%8A%A1.html" rel="prev" title="日志服务">
                日志服务 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript" target="_blank" rel="noopener">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/cunshang.jpg"
                alt="PiQianChao" />
            
              <p class="site-author-name" itemprop="name">PiQianChao</p>
              <p class="site-description motion-element" itemprop="description">My Blog</p>
          </div>
            
           <iframe  frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=694660&auto=1&height=66"></iframe>
          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/%7C%7C%20archive">
              
                  <span class="site-state-item-count">650</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">82</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">63</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/pidada" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:pichaochao1119@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#SQL内置函数使用大全"><span class="nav-number">1.</span> <span class="nav-text">SQL内置函数使用大全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#通用聚合函数"><span class="nav-number">2.</span> <span class="nav-text">通用聚合函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安全检测函数"><span class="nav-number">3.</span> <span class="nav-text">安全检测函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Map映射函数"><span class="nav-number">4.</span> <span class="nav-text">Map映射函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#估算函数"><span class="nav-number">5.</span> <span class="nav-text">估算函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数学统计函数"><span class="nav-number">6.</span> <span class="nav-text">数学统计函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数学计算函数"><span class="nav-number">7.</span> <span class="nav-text">数学计算函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#字符串函数"><span class="nav-number">8.</span> <span class="nav-text">字符串函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日期和时间函数"><span class="nav-number">9.</span> <span class="nav-text">日期和时间函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#函数类型"><span class="nav-number">9.1.</span> <span class="nav-text">函数类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日期时间类型"><span class="nav-number">9.2.</span> <span class="nav-text">日期时间类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日期函数"><span class="nav-number">9.3.</span> <span class="nav-text">日期函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时间函数"><span class="nav-number">9.4.</span> <span class="nav-text">时间函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式说明"><span class="nav-number">9.5.</span> <span class="nav-text">格式说明</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时间段对齐函数"><span class="nav-number">9.6.</span> <span class="nav-text">时间段对齐函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时间间隔函数"><span class="nav-number">9.7.</span> <span class="nav-text">时间间隔函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#函数区间单位"><span class="nav-number">9.8.</span> <span class="nav-text">函数区间单位</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#时序补全函数time-series"><span class="nav-number">9.9.</span> <span class="nav-text">时序补全函数time_series</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#URL函数"><span class="nav-number">10.</span> <span class="nav-text">URL函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#正则式函数"><span class="nav-number">11.</span> <span class="nav-text">正则式函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JSON函数"><span class="nav-number">12.</span> <span class="nav-text">JSON函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#类型转换函数"><span class="nav-number">13.</span> <span class="nav-text">类型转换函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#函数格式"><span class="nav-number">13.1.</span> <span class="nav-text">函数格式</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#参数"><span class="nav-number">13.2.</span> <span class="nav-text">参数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#示例"><span class="nav-number">13.3.</span> <span class="nav-text">示例</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IP地理函数"><span class="nav-number">14.</span> <span class="nav-text">IP地理函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#常用函数"><span class="nav-number">14.1.</span> <span class="nav-text">常用函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#使用demo"><span class="nav-number">14.2.</span> <span class="nav-text">使用demo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#地理函数"><span class="nav-number">15.</span> <span class="nav-text">地理函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Group-by用法"><span class="nav-number">16.</span> <span class="nav-text">Group by用法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#窗口函数"><span class="nav-number">17.</span> <span class="nav-text">窗口函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#窗口函数用处"><span class="nav-number">17.1.</span> <span class="nav-text">窗口函数用处</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#什么是窗口函数"><span class="nav-number">17.2.</span> <span class="nav-text">什么是窗口函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#函数"><span class="nav-number">17.3.</span> <span class="nav-text">函数</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#demo-1"><span class="nav-number">17.4.</span> <span class="nav-text">demo-1</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#demo-2"><span class="nav-number">17.5.</span> <span class="nav-text">demo-2</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#having语法"><span class="nav-number">18.</span> <span class="nav-text">having语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#order-by语法"><span class="nav-number">19.</span> <span class="nav-text">order by语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#limit语法"><span class="nav-number">20.</span> <span class="nav-text">limit语法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#用法"><span class="nav-number">20.1.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#demo"><span class="nav-number">20.2.</span> <span class="nav-text">demo</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#case-when语法"><span class="nav-number">21.</span> <span class="nav-text">case when语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#if语法"><span class="nav-number">22.</span> <span class="nav-text">if语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#coalesce语法"><span class="nav-number">23.</span> <span class="nav-text">coalesce语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#nullif语法"><span class="nav-number">24.</span> <span class="nav-text">nullif语法</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#二进制字符串函数"><span class="nav-number">25.</span> <span class="nav-text">二进制字符串函数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#位运算"><span class="nav-number">26.</span> <span class="nav-text">位运算</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#同比和环比函数"><span class="nav-number">27.</span> <span class="nav-text">同比和环比函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#demo-1-v2"><span class="nav-number">27.1.</span> <span class="nav-text">demo-1</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#比较函数和运算符"><span class="nav-number">28.</span> <span class="nav-text">比较函数和运算符</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#比较运算符"><span class="nav-number">28.1.</span> <span class="nav-text">比较运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#范围运算符-BETWEEN"><span class="nav-number">28.2.</span> <span class="nav-text">范围运算符 BETWEEN</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IS-NULL-和-IS-NOT-NULL"><span class="nav-number">28.3.</span> <span class="nav-text">IS NULL 和 IS NOT NULL</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#GREATEST-和-LEAST"><span class="nav-number">28.4.</span> <span class="nav-text">GREATEST 和 LEAST</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#比较判断：all、any、some"><span class="nav-number">28.5.</span> <span class="nav-text">比较判断：all、any、some</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lambda表达式"><span class="nav-number">29.</span> <span class="nav-text">Lambda表达式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#filter"><span class="nav-number">29.1.</span> <span class="nav-text">filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#map-filter"><span class="nav-number">29.2.</span> <span class="nav-text">map_filter</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#reduce"><span class="nav-number">29.3.</span> <span class="nav-text">reduce</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#transform"><span class="nav-number">29.4.</span> <span class="nav-text">transform</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#zip-with"><span class="nav-number">29.5.</span> <span class="nav-text">zip_with</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#逻辑函数"><span class="nav-number">30.</span> <span class="nav-text">逻辑函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#运算符"><span class="nav-number">30.1.</span> <span class="nav-text">运算符</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#NULL参与逻辑运算符"><span class="nav-number">30.2.</span> <span class="nav-text">NULL参与逻辑运算符</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#join"><span class="nav-number">31.</span> <span class="nav-text">join</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#inner-join"><span class="nav-number">31.1.</span> <span class="nav-text">inner join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#left-outer-join"><span class="nav-number">31.2.</span> <span class="nav-text">left (outer) join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#right-outer-join"><span class="nav-number">31.3.</span> <span class="nav-text">right (outer) join</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#full-outer-join"><span class="nav-number">31.4.</span> <span class="nav-text">full (outer) join</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#unnest语法"><span class="nav-number">32.</span> <span class="nav-text">unnest语法</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#背景"><span class="nav-number">32.1.</span> <span class="nav-text">背景</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#语法结构"><span class="nav-number">32.2.</span> <span class="nav-text">语法结构</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遍历数组的每个元素"><span class="nav-number">32.3.</span> <span class="nav-text">遍历数组的每个元素</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#遍历map"><span class="nav-number">32.4.</span> <span class="nav-text">遍历map</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#格式化显示histogram-numeric-histogram"><span class="nav-number">32.5.</span> <span class="nav-text">格式化显示histogram,numeric_histogram</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#histogram"><span class="nav-number">32.5.1.</span> <span class="nav-text">histogram</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#numeric-histogram"><span class="nav-number">32.5.2.</span> <span class="nav-text">numeric_histogram</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#电话号码函数"><span class="nav-number">33.</span> <span class="nav-text">电话号码函数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#函数列表"><span class="nav-number">33.1.</span> <span class="nav-text">函数列表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#demo-v2"><span class="nav-number">33.2.</span> <span class="nav-text">demo</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

	
	
		<script type="text/javascript" charset="utf-8" src="/js/tagcloud.js"></script>
		<script type="text/javascript" charset="utf-8" src="/js/tagcanvas.js"></script>
		<div class="widget-wrap">
			<h3 class="widget-title">标签云</h3>
			<div id="myCanvasContainer" class="widget tagcloud">
			<canvas width="250" height="250" id="resCanvas" style="width=100%">
				 <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hadoop/" rel="tag">Hadoop</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hive/" rel="tag">Hive</a><span class="tag-list-count">13</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/IC/" rel="tag">IC</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JJ/" rel="tag">JJ</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/LeetCode/" rel="tag">LeetCode</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Leetcode/" rel="tag">Leetcode</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySQL/" rel="tag">MySQL</a><span class="tag-list-count">62</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/NLP/" rel="tag">NLP</a><span class="tag-list-count">7</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/TensorFlow/" rel="tag">TensorFlow</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Tool/" rel="tag">Tool</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/d3/" rel="tag">d3</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dash/" rel="tag">dash</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/go/" rel="tag">go</a><span class="tag-list-count">42</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/highcharts/" rel="tag">highcharts</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/json/" rel="tag">json</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kaggle/" rel="tag">kaggle</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/numpy/" rel="tag">numpy</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pandas/" rel="tag">pandas</a><span class="tag-list-count">98</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/plotly/" rel="tag">plotly</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/px/" rel="tag">px</a><span class="tag-list-count">34</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pyecharts/" rel="tag">pyecharts</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pyg2plot/" rel="tag">pyg2plot</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/" rel="tag">python</a><span class="tag-list-count">86</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spark/" rel="tag">spark</a><span class="tag-list-count">19</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/spider/" rel="tag">spider</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sql/" rel="tag">sql</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sqlzoo/" rel="tag">sqlzoo</a><span class="tag-list-count">18</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/tableau/" rel="tag">tableau</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%92%E8%81%94%E7%BD%91/" rel="tag">互联网</a><span class="tag-list-count">38</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BA%A7%E5%93%81/" rel="tag">产品</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8C%BA%E5%9F%9F%E9%93%BE/" rel="tag">区域链</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8F%AF%E8%A7%86%E5%8C%96/" rel="tag">可视化</a><span class="tag-list-count">110</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%90%B4%E6%81%A9%E8%BE%BE/" rel="tag">吴恩达</a><span class="tag-list-count">15</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%9F%BA%E9%87%91/" rel="tag">基金</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag">大数据</a><span class="tag-list-count">48</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%AD%97%E5%85%B8/" rel="tag">字典</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%88%90%E9%95%BF/" rel="tag">成长</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8A%95%E8%B5%84/" rel="tag">投资</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%8E%A8%E8%8D%90%E7%B3%BB%E7%BB%9F/" rel="tag">推荐系统</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" rel="tag">数据分析</a><span class="tag-list-count">35</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86/" rel="tag">数据处理</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E5%BA%93/" rel="tag">数据库</a><span class="tag-list-count">101</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/" rel="tag">数据结构</a><span class="tag-list-count">11</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%85%E6%B8%B8/" rel="tag">旅游</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/" rel="tag">时间序列</a><span class="tag-list-count">9</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0/" rel="tag">机器学习</a><span class="tag-list-count">73</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B7%B1%E5%9C%B3/" rel="tag">深圳</a><span class="tag-list-count">14</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%B7%B1%E6%BC%82/" rel="tag">深漂</a><span class="tag-list-count">22</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%88%AC%E8%99%AB/" rel="tag">爬虫</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%9F%E6%B4%BB/" rel="tag">生活</a><span class="tag-list-count">51</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%94%B5%E5%BD%B1/" rel="tag">电影</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a><span class="tag-list-count">12</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BB%8F%E6%B5%8E/" rel="tag">经济</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BC%96%E7%A8%8B/" rel="tag">编程</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%BE%8E%E9%A3%9F/" rel="tag">美食</a><span class="tag-list-count">16</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E5%8A%A8%E5%8C%96/" rel="tag">自动化</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%87%AA%E6%88%91%E7%AE%A1%E7%90%86/" rel="tag">自我管理</a><span class="tag-list-count">8</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA/" rel="tag">计算机</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%BF%90%E8%90%A5/" rel="tag">运营</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%98%85%E8%AF%BB/" rel="tag">阅读</a><span class="tag-list-count">28</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%B1%BC%E5%A4%B4%E8%B1%86%E8%85%90%E6%B1%A4/" rel="tag">鱼头豆腐汤</a><span class="tag-list-count">1</span></li></ul>
			</canvas>
			</div>
		</div>
	

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">PiQianChao</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共916.7k字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="true"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  

    
      <script id="dsq-count-scr" src="https://pidada.disqus.com/count.js" async></script>
    

    
      <script type="text/javascript">
        var disqus_config = function () {
          this.page.url = 'http://www.renpeter.cn/2020/04/24/SQL%E5%86%85%E7%BD%AE%E5%87%BD%E6%95%B0%E6%89%8B%E5%86%8C.html';
          this.page.identifier = '2020/04/24/SQL内置函数手册.html';
          this.page.title = 'SQL内置函数手册';
        };
        var d = document, s = d.createElement('script');
        s.src = 'https://pidada.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      </script>
    

  




	





  














  





  

  

  

  
  

  
  
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
          processEscapes: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
      });
    </script>

    <script type="text/x-mathjax-config">
      MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
          all[i].SourceElement().parentNode.className += ' has-jax';
        }
      });
    </script>
    <script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
  


  
  <script type="text/javascript" src="/js/src/js.cookie.js?v=5.1.4"></script>
  <script type="text/javascript" src="/js/src/scroll-cookie.js?v=5.1.4"></script>


  




<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>


</body>
</html>
